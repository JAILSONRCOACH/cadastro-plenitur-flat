<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Plenitur Flats</title>
    <meta
      name="description"
      content="Painel administrativo da Plenitur Flats para gestão de reservas, contratos e calendário."
    />
    <meta
      property="og:title"
      content="Painel Administrativo - Plenitur Flats"
    />
    <meta
      property="og:description"
      content="Gestão de reservas, contratos e calendário."
    />
    <meta property="og:type" content="website" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="icon" href="public/images/favicon.png" type="image/png" />
    <link rel="shortcut icon" href="public/images/favicon.png" />
    <link rel="apple-touch-icon" href="public/images/favicon.png" />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/date-fns@2.30.0/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Sora:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --admin-ink: #0f172a;
        --admin-muted: #475569;
        --admin-accent: #1d4ed8;
        --admin-accent-soft: #e0ebff;
        --admin-border: #e2e8f0;
        --admin-bg: #f7f4ef;
        --admin-approved-bg: #fee2e2;
        --admin-approved-text: #b91c1c;
        --admin-pending-bg: #fef3c7;
        --admin-pending-text: #b45309;
        --admin-blocked-bg: #e2e8f0;
        --admin-blocked-text: #1e293b;
        --calendar-available-bg: #ffffff;
        --calendar-available-border: #10b981;
        --calendar-available-text: #065f46;
        --calendar-soldout-bg: #ffedd5;
        --calendar-soldout-border: #f97316;
        --calendar-soldout-text: #9a3412;
        --calendar-unavailable-bg: #e5e7eb;
        --calendar-unavailable-border: #6b7280;
        --calendar-unavailable-text: #111827;
        --calendar-attention-bg: #fee2e2;
        --calendar-attention-border: #ef4444;
        --calendar-attention-text: #991b1b;
      }

      body {
        font-family: "Manrope", sans-serif;
        color: var(--admin-ink);
        background:
          radial-gradient(
            120% 80% at 0% 0%,
            rgba(59, 130, 246, 0.12),
            transparent 60%
          ),
          radial-gradient(
            70% 60% at 100% 0%,
            rgba(15, 23, 42, 0.08),
            transparent 60%
          ),
          var(--admin-bg);
        font-size: 16px;
        line-height: 1.6;
        overflow-x: hidden;
        overflow-y: auto;
      }

      h1,
      h2,
      h3,
      h4,
      .admin-title {
        font-family: "Sora", sans-serif;
        letter-spacing: -0.01em;
      }

      @media (min-width: 1024px) {
        body {
          overflow: hidden;
        }
      }

      .sidebar-link.active {
        background-color: var(--admin-accent-soft);
        color: var(--admin-accent);
        border-right: 3px solid var(--admin-accent);
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(14px);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.35rem;
      }

      .calendar-weekday {
        text-align: center;
        font-size: 0.88rem;
        font-weight: 500;
        color: #94a3b8;
        padding: 0.1rem 0;
      }

      .calendar-day {
        background: var(--calendar-available-bg);
        border: 2px solid var(--calendar-available-border);
        border-radius: 8px;
        min-height: 0;
        aspect-ratio: 1 / 1;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--calendar-available-text);
        font-weight: 700;
        transition:
          transform 0.15s ease,
          border-color 0.15s ease,
          background-color 0.15s ease;
      }

      .calendar-day:hover {
        transform: translateY(-1px);
      }

      .calendar-day.is-today {
        box-shadow: inset 0 0 0 2px #2563eb;
      }

      .calendar-day.is-empty {
        background: transparent;
        border: none;
        pointer-events: none;
      }

      .calendar-day-number {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
      }

      .calendar-day-meta {
        position: absolute;
        right: 0.25rem;
        bottom: 0.2rem;
        font-size: 0.62rem;
        font-weight: 700;
        color: inherit;
        opacity: 0.8;
      }

      .calendar-day.is-soldout {
        background: var(--calendar-soldout-bg);
        border-color: var(--calendar-soldout-border);
        color: var(--calendar-soldout-text);
      }

      .calendar-day.is-unavailable {
        background: var(--calendar-unavailable-bg);
        border-color: var(--calendar-unavailable-border);
        color: var(--calendar-unavailable-text);
      }

      .calendar-day.is-attention {
        background: var(--calendar-attention-bg);
        border-color: var(--calendar-attention-border);
        color: var(--calendar-attention-text);
      }

      .calendar-day.is-available {
        background: var(--calendar-available-bg);
        border-color: var(--calendar-available-border);
        color: var(--calendar-available-text);
      }

      .calendar-legend-dot {
        width: 1rem;
        height: 1rem;
        border-radius: 0.35rem;
        border: 2px solid transparent;
      }

      .calendar-legend-dot.is-available {
        background: var(--calendar-available-bg);
        border-color: var(--calendar-available-border);
      }

      .calendar-legend-dot.is-soldout {
        background: var(--calendar-soldout-bg);
        border-color: var(--calendar-soldout-border);
      }

      .calendar-legend-dot.is-unavailable {
        background: var(--calendar-unavailable-bg);
        border-color: var(--calendar-unavailable-border);
      }

      .calendar-legend-dot.is-attention {
        background: var(--calendar-attention-bg);
        border-color: var(--calendar-attention-border);
      }

      .calendar-day-detail-card {
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        background: #ffffff;
        padding: 0.9rem;
      }

      .calendar-day-detail-item {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.55rem 0.65rem;
        background: #f8fafc;
      }

      .calendar-day-detail-item.is-soldout {
        border-color: var(--calendar-soldout-border);
        background: var(--calendar-soldout-bg);
      }

      .calendar-day-detail-item.is-unavailable {
        border-color: var(--calendar-unavailable-border);
        background: var(--calendar-unavailable-bg);
      }

      .calendar-day-detail-item.is-attention {
        border-color: var(--calendar-attention-border);
        background: var(--calendar-attention-bg);
      }

      .calendar-year-card {
        background: #ffffff;
        border: 1px solid var(--admin-border);
        border-radius: 18px;
        padding: 0.9rem;
        box-shadow: 0 16px 30px -24px rgba(15, 23, 42, 0.35);
      }

      .calendar-year-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }

      .calendar-year-weekdays {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.2rem;
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
      }

      .calendar-year-days {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.2rem;
        margin-top: 0.35rem;
      }

      .calendar-year-day {
        height: 2rem;
        width: 100%;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.76rem;
        font-weight: 600;
        color: var(--admin-muted);
        cursor: pointer;
        transition: transform 0.12s ease;
      }

      .calendar-year-day:hover {
        transform: translateY(-1px);
      }

      .calendar-year-day.is-approved {
        border-color: var(--calendar-soldout-border);
        background: var(--calendar-soldout-bg);
        color: var(--calendar-soldout-text);
      }

      .calendar-year-day.is-pending {
        border-color: var(--calendar-attention-border);
        background: var(--calendar-attention-bg);
        color: var(--calendar-attention-text);
      }

      .calendar-year-day.is-unavailable {
        border-color: var(--calendar-unavailable-border);
        background: var(--calendar-unavailable-bg);
        color: var(--calendar-unavailable-text);
      }

      .calendar-year-day.has-status {
        font-weight: 700;
      }

      .calendar-year-day.is-empty {
        border: none;
        background: transparent;
        pointer-events: none;
      }

      .calendar-year-pill {
        height: 4px;
        width: 16px;
        border-radius: 999px;
        background: #e2e8f0;
      }

      .calendar-year-pill.is-approved {
        background: var(--calendar-soldout-border);
      }

      .calendar-year-pill.is-pending {
        background: var(--calendar-attention-border);
      }

      .calendar-year-pill.is-unavailable {
        background: var(--calendar-unavailable-border);
      }

      @media (max-width: 640px) {
        .text-xs {
          font-size: 0.85rem;
        }

        .text-sm {
          font-size: 0.95rem;
        }

        .calendar-grid {
          gap: 0.3rem;
        }

        .calendar-day {
          border-radius: 6px;
        }

        .calendar-day-number {
          font-size: 1.9rem;
        }

        .calendar-year-card {
          padding: 0.75rem;
        }

        .calendar-year-day {
          height: 2.2rem;
          font-size: 0.84rem;
        }
      }
    </style>
  </head>

  <body class="admin-theme min-h-screen">
    <!-- LOGIN SCREEN -->
    <div
      id="login-screen"
      class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center"
    >
      <div
        class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center"
      >
        <img
          src="public/images/logo.png"
          alt="Plenitur Flats"
          class="h-16 mx-auto mb-6 object-contain"
        />
        <h2 class="text-2xl font-bold text-gray-800 mb-2">
          Acesso Administrativo
        </h2>
        <p class="text-gray-500 mb-6">
          Digite seu email e senha para acessar o painel.
        </p>

        <form onsubmit="handleLogin(event)" class="space-y-4">
          <input
            type="email"
            id="email-input"
            placeholder="Email do administrador"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
          />
          <input
            type="password"
            id="password-input"
            placeholder="Senha de administrador"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
          />
          <button
            type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg"
          >
            Entrar
          </button>
        </form>
        <p id="login-error" class="text-red-500 text-sm mt-4 hidden">
          Email ou senha incorretos. Tente novamente.
        </p>
      </div>
    </div>

    <!-- MAIN APP (Hidden by default) -->
    <div
      id="app-content"
      class="flex-col lg:flex-row min-h-screen lg:h-screen hidden"
    >
      <!-- SIDEBAR -->
      <aside
        id="sidebar"
        class="fixed lg:static inset-y-0 left-0 w-72 max-w-[85vw] lg:w-64 bg-white border-b lg:border-b-0 lg:border-r border-gray-200 flex flex-col z-30 shadow-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-200"
      >
        <div
          class="h-16 flex items-center justify-center border-b border-gray-100 bg-white"
        >
          <img
            src="public/images/logo.png"
            alt="Logo"
            class="h-8 object-contain"
          />
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
          <a
            href="#"
            onclick="showSection('dashboard')"
            id="nav-dashboard"
            class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition group active"
          >
            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Visão
            Geral
          </a>
          <a
            href="#"
            onclick="showSection('pending')"
            id="nav-pending"
            class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition group"
          >
            <i data-lucide="file-signature" class="w-5 h-5 mr-3"></i> Assinar
            Contratos
            <span
              id="pending-badge"
              class="ml-auto bg-red-100 text-red-600 text-xs font-bold px-2 py-0.5 rounded-full hidden"
              >0</span
            >
          </a>
          <a
            href="#"
            onclick="showSection('calendar')"
            id="nav-calendar"
            class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition group"
          >
            <i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Calendário
          </a>
          <a
            href="#"
            onclick="showSection('all-reservations')"
            id="nav-all"
            class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition group"
          >
            <i data-lucide="list" class="w-5 h-5 mr-3"></i> Todas Reservas
          </a>
        </nav>

        <div class="p-4 border-t border-gray-100">
          <button
            onclick="logout()"
            class="flex items-center w-full px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition"
          >
            <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Sair do Sistema
          </button>
        </div>
      </aside>

      <div
        id="sidebar-overlay"
        onclick="closeSidebar()"
        class="fixed inset-0 bg-black/40 z-20 hidden lg:hidden"
      ></div>

      <!-- CONTENT AREA -->
      <main
        class="flex-1 h-full overflow-visible lg:overflow-y-auto bg-slate-50 relative"
      >
        <header
          class="bg-white shadow-sm h-16 flex items-center justify-between px-4 sm:px-8 sticky top-0 z-10"
        >
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <button
              onclick="toggleSidebar()"
              class="lg:hidden p-2 rounded-lg hover:bg-gray-100 text-gray-600"
            >
              <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            <h1
              id="page-title"
              class="text-lg sm:text-xl font-bold text-gray-800 hidden"
            >
              Visão Geral
            </h1>
          </div>

          <div
            class="absolute left-1/2 -translate-x-1/2 flex flex-col items-center leading-tight"
          >
            <img
              src="public/images/logo.png"
              alt="Plenitur Flats"
              class="h-6 object-contain sm:hidden"
            />
            <span class="text-sm sm:text-base font-semibold text-gray-700"
              >Painel Administrativo</span
            >
          </div>

          <div class="flex items-center gap-4 flex-1 justify-end">
            <div class="text-sm text-right hidden sm:block">
              <p class="font-medium text-gray-900">Administrador</p>
              <p class="text-gray-500 text-xs">Plenitur Flats</p>
            </div>
            <div
              class="h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold"
            >
              A
            </div>
          </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto">
          <div class="mb-6">
            <h2
              id="page-title-inline"
              class="text-lg sm:text-xl font-semibold text-gray-800"
            >
              Visão Geral
            </h2>
          </div>

          <!-- DASHBOARD VIEW -->
          <div id="section-dashboard" class="space-y-6 section-view">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm font-medium text-gray-500">
                      Contratos Pendentes
                    </p>
                    <h3
                      class="text-3xl font-bold text-gray-900 mt-2"
                      id="stat-pending"
                    >
                      0
                    </h3>
                  </div>
                  <div class="p-2 bg-yellow-50 rounded-lg text-yellow-600">
                    <i data-lucide="alert-circle" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm font-medium text-gray-500">
                      Reservas Este Mês
                    </p>
                    <h3
                      class="text-3xl font-bold text-gray-900 mt-2"
                      id="stat-month"
                    >
                      0
                    </h3>
                  </div>
                  <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                    <i data-lucide="calendar-check" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm font-medium text-gray-500">
                      Reservado no Mês
                    </p>
                    <h3
                      class="text-3xl font-bold text-gray-900 mt-2"
                      id="stat-revenue"
                    >
                      R$ 0,00
                    </h3>
                  </div>
                  <div class="p-2 bg-green-50 rounded-lg text-green-600">
                    <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm font-medium text-gray-500">
                      Valor Recebido (Sinal/Quitado)
                    </p>
                    <h3
                      class="text-3xl font-bold text-emerald-700 mt-2"
                      id="stat-received"
                    >
                      R$ 0,00
                    </h3>
                  </div>
                  <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
                    <i data-lucide="wallet" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm font-medium text-gray-500">
                      Saldo a Receber (Mês)
                    </p>
                    <h3
                      class="text-3xl font-bold text-amber-700 mt-2"
                      id="stat-receivable"
                    >
                      R$ 0,00
                    </h3>
                  </div>
                  <div class="p-2 bg-amber-50 rounded-lg text-amber-600">
                    <i data-lucide="hourglass" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
              <div
                class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm font-medium text-gray-500">
                      Taxa de Ocupação (Mês)
                    </p>
                    <h3
                      class="text-3xl font-bold text-indigo-700 mt-2"
                      id="stat-occupancy"
                    >
                      0%
                    </h3>
                    <p
                      id="stat-occupancy-detail"
                      class="text-xs text-gray-500 mt-1"
                    >
                      0 de 0 noites ocupadas
                    </p>
                  </div>
                  <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                    <i data-lucide="pie-chart" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
              <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-gray-800">Taxa de Ocupação (Ano)</h3>
                  <span class="text-xs text-gray-500">Noites ocupadas (%)</span>
                </div>
                <div class="h-72">
                  <canvas id="dashboard-occupancy-chart"></canvas>
                </div>
              </div>

              <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 p-6"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-gray-800">Financeiro (Ano)</h3>
                  <span class="text-xs text-gray-500">Recebido x a receber</span>
                </div>
                <div class="h-72">
                  <canvas id="dashboard-financial-chart"></canvas>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
              <!-- Next Arrivals -->
              <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
              >
                <div
                  class="p-6 border-b border-gray-100 flex justify-between items-center"
                >
                  <h3 class="font-bold text-gray-800">Próximos Check-ins</h3>
                  <button
                    onclick="showSection('all-reservations')"
                    class="text-sm text-blue-600 hover:underline"
                  >
                    Ver todos
                  </button>
                </div>
                <div class="p-6">
                  <div id="next-arrivals-list" class="space-y-4">
                    <!-- Injected JS -->
                    <p class="text-gray-400 text-center">
                      Nenhum check-in próximo.
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
              >
                <div
                  class="p-6 border-b border-gray-100 flex items-center justify-between"
                >
                  <h3 class="font-bold text-gray-800">Datas Indisponíveis</h3>
                  <span
                    id="dashboard-blocked-count"
                    class="text-sm text-gray-500"
                  ></span>
                </div>
                <div class="p-6">
                  <div id="dashboard-blocked-list" class="space-y-4">
                    <p class="text-gray-400 text-center">
                      Nenhuma data indisponível ativa.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PENDING CONTRACTS VIEW -->
          <div id="section-pending" class="hidden section-view space-y-6">
            <div
              class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
            >
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                    <tr>
                      <th class="px-6 py-4 font-semibold">Cliente</th>
                      <th class="px-6 py-4 font-semibold">
                        Check-in / Check-out
                      </th>
                      <th class="px-6 py-4 font-semibold">Valor</th>
                      <th class="px-6 py-4 font-semibold text-right">Ação</th>
                    </tr>
                  </thead>
                  <tbody
                    id="pending-table-body"
                    class="divide-y divide-gray-100 text-sm"
                  >
                    <!-- Injected JS -->
                  </tbody>
                </table>
              </div>
              <div
                id="pending-empty"
                class="hidden p-12 text-center text-gray-400"
              >
                <i
                  data-lucide="check-circle"
                  class="w-12 h-12 mx-auto mb-3 text-green-400"
                ></i>
                <p>Tudo certo! Nenhuma assinatura pendente.</p>
              </div>
            </div>
          </div>

          <!-- CALENDAR VIEW -->
          <div id="section-calendar" class="hidden section-view h-full">
            <div
              class="bg-white/95 rounded-2xl shadow-xl border border-slate-200 p-6 backdrop-blur"
            >
              <div
                class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-6"
              >
                <div class="space-y-1">
                  <h3
                    class="font-bold text-xl text-slate-900"
                    id="calendar-month-title"
                  >
                    Fevereiro 2026
                  </h3>
                  <p class="text-sm text-slate-600">
                    Filtre por mês e ano para acompanhar as reservas.
                  </p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <div
                    class="flex items-center rounded-full border border-slate-200 bg-white shadow-sm overflow-hidden"
                  >
                    <button
                      id="calendar-view-month"
                      onclick="setCalendarView('month')"
                      class="px-4 py-2 text-sm font-semibold bg-slate-100 text-slate-800"
                    >
                      Mês
                    </button>
                    <button
                      id="calendar-view-year"
                      onclick="setCalendarView('year')"
                      class="px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700"
                    >
                      Ano
                    </button>
                  </div>
                  <div
                    id="calendar-month-filter"
                    class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-2 shadow-sm"
                  >
                    <label
                      for="calendar-month-select"
                      class="text-sm text-slate-500"
                      >Mês</label
                    >
                    <select
                      id="calendar-month-select"
                      class="bg-transparent text-sm font-medium text-slate-700 focus:outline-none"
                    ></select>
                  </div>
                  <div
                    id="calendar-year-filter"
                    class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-2 shadow-sm"
                  >
                    <label
                      for="calendar-year-select"
                      class="text-sm text-slate-500"
                      >Ano</label
                    >
                    <select
                      id="calendar-year-select"
                      class="bg-transparent text-sm font-medium text-slate-700 focus:outline-none"
                    ></select>
                  </div>
                  <button
                    type="button"
                    onclick="openManualBlockForm()"
                    class="inline-flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 shadow-sm"
                  >
                    <i data-lucide="calendar-x" class="w-4 h-4"></i>
                    Bloquear datas
                  </button>
                  <div class="flex items-center gap-1">
                    <button
                      onclick="changeMonth(-1)"
                      class="p-2.5 hover:bg-slate-100 rounded-full"
                    >
                      <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <button
                      onclick="changeMonth(1)"
                      class="p-2.5 hover:bg-slate-100 rounded-full"
                    >
                      <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div
                id="manual-block-form-panel"
                class="hidden mb-6 border border-slate-200 rounded-xl bg-slate-50 p-4"
              >
                <div
                  class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4"
                >
                  <h4
                    id="manual-block-form-title"
                    class="text-sm font-semibold text-slate-800"
                  >
                    Bloquear período no calendário
                  </h4>
                  <button
                    type="button"
                    onclick="closeManualBlockForm()"
                    class="text-xs font-medium text-slate-500 hover:text-slate-700"
                  >
                    Fechar
                  </button>
                </div>
                <form
                  id="manual-block-form"
                  onsubmit="saveManualBlock(event)"
                  class="space-y-4"
                >
                  <input type="hidden" id="manual-block-id" />
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                      <label
                        for="manual-block-client-name"
                        class="block text-sm font-medium text-slate-700 mb-1"
                        >Nome do cliente / referência *</label
                      >
                      <input
                        id="manual-block-client-name"
                        type="text"
                        required
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
                        placeholder="Ex: Manutenção, Proprietário, Cliente XYZ"
                      />
                    </div>
                    <div>
                      <label
                        for="manual-block-start-date"
                        class="block text-sm font-medium text-slate-700 mb-1"
                        >Data início *</label
                      >
                      <input
                        id="manual-block-start-date"
                        type="date"
                        required
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
                      />
                    </div>
                    <div>
                      <label
                        for="manual-block-end-date"
                        class="block text-sm font-medium text-slate-700 mb-1"
                        >Data fim *</label
                      >
                      <input
                        id="manual-block-end-date"
                        type="date"
                        required
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
                      />
                    </div>
                    <div class="md:col-span-2">
                      <label
                        for="manual-block-notes"
                        class="block text-sm font-medium text-slate-700 mb-1"
                        >Observações</label
                      >
                      <textarea
                        id="manual-block-notes"
                        rows="3"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
                        placeholder="Motivo do bloqueio, detalhes, restrições, etc."
                      ></textarea>
                    </div>
                  </div>
                  <div class="flex flex-wrap items-center gap-2">
                    <button
                      id="manual-block-submit"
                      type="submit"
                      class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
                    >
                      <span id="manual-block-submit-label">Salvar bloqueio</span>
                    </button>
                    <button
                      type="button"
                      onclick="resetManualBlockForm()"
                      class="px-3 py-2 rounded-lg bg-white border border-slate-300 text-sm font-medium text-slate-700 hover:bg-slate-100"
                    >
                      Limpar
                    </button>
                  </div>
                </form>
              </div>

              <div id="calendar-month-view" class="space-y-4">
                <div class="overflow-x-auto">
                  <div class="calendar-grid min-w-[320px]">
                    <!-- Weekday Headers -->
                    <div class="calendar-weekday">dom.</div>
                    <div class="calendar-weekday">seg.</div>
                    <div class="calendar-weekday">ter.</div>
                    <div class="calendar-weekday">qua.</div>
                    <div class="calendar-weekday">qui.</div>
                    <div class="calendar-weekday">sex.</div>
                    <div class="calendar-weekday">sáb.</div>

                    <!-- Calendar Grid (Injected) -->
                    <div id="calendar-grid" class="contents"></div>
                  </div>
                </div>

                <div class="mt-4 flex gap-4 text-sm text-slate-500">
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-available"></span>
                    Disponível para reservas
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-soldout"></span>
                    Esgotado
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-unavailable"></span>
                    Indisponível
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-attention"></span>
                    Precisa de atenção
                  </div>
                </div>

                <div id="calendar-day-detail-card" class="calendar-day-detail-card mt-4 hidden">
                  <div class="flex items-center justify-between gap-3 mb-2">
                    <h5
                      id="calendar-day-detail-title"
                      class="text-sm font-semibold text-slate-800"
                    >
                      Detalhes do dia
                    </h5>
                    <button
                      type="button"
                      onclick="closeCalendarDayDetails()"
                      class="text-xs font-medium text-slate-500 hover:text-slate-700"
                    >
                      Fechar
                    </button>
                  </div>
                  <div
                    id="calendar-day-detail-list"
                    class="space-y-2 text-sm text-slate-700"
                  >
                    <!-- Injected JS -->
                  </div>
                </div>

                <div class="mt-6 border-t border-gray-100 pt-6">
                  <div
                    class="flex flex-wrap items-center justify-between gap-2 mb-3"
                  >
                    <h4 class="text-base font-semibold text-slate-800">
                      Relação de clientes do mês
                    </h4>
                    <span
                      id="calendar-list-count"
                      class="text-sm text-slate-500"
                    ></span>
                  </div>
                  <div id="calendar-list-table" class="space-y-3">
                    <div class="hidden sm:block overflow-x-auto">
                      <table class="w-full text-left text-sm">
                        <thead
                          class="text-xs uppercase text-gray-500 bg-gray-50"
                        >
                          <tr>
                            <th class="px-4 py-3 font-semibold">Cliente</th>
                            <th class="px-4 py-3 font-semibold">Período</th>
                            <th class="px-4 py-3 font-semibold">Valor</th>
                            <th class="px-4 py-3 font-semibold">Status</th>
                          </tr>
                        </thead>
                        <tbody
                          id="calendar-reservations-body"
                          class="divide-y divide-gray-100"
                        >
                          <!-- Injected JS -->
                        </tbody>
                      </table>
                    </div>
                    <div
                      id="calendar-reservations-cards"
                      class="sm:hidden space-y-3"
                    >
                      <!-- Injected JS -->
                    </div>
                  </div>
                  <div
                    id="calendar-empty"
                    class="hidden text-center text-gray-400 text-sm py-6"
                  >
                    Nenhuma reserva para este período.
                  </div>
                </div>
              </div>

              <div id="calendar-year-view" class="hidden space-y-4">
                <div
                  id="calendar-year-grid"
                  class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"
                >
                  <!-- Injected JS -->
                </div>
                <div class="mt-2 flex gap-4 text-sm text-slate-500">
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-available"></span>
                    Disponível para reservas
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-soldout"></span>
                    Esgotado
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-unavailable"></span>
                    Indisponível
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="calendar-legend-dot is-attention"></span>
                    Precisa de atenção
                  </div>
                </div>
                <p class="text-xs text-slate-500">
                  Toque em um dia para ver os clientes e bloqueios daquele período.
                </p>
              </div>

              <div class="mt-6 border-t border-gray-100 pt-6">
                <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                  <h4 class="text-base font-semibold text-slate-800">
                    Bloqueios manuais
                  </h4>
                  <span
                    id="manual-block-count"
                    class="text-sm text-slate-500"
                  ></span>
                </div>
                <div id="manual-block-table-wrapper" class="space-y-3">
                  <div class="hidden sm:block overflow-x-auto">
                    <table class="w-full text-left text-sm">
                      <thead class="text-xs uppercase text-gray-500 bg-gray-50">
                        <tr>
                          <th class="px-4 py-3 font-semibold">Referência</th>
                          <th class="px-4 py-3 font-semibold">Período</th>
                          <th class="px-4 py-3 font-semibold">Status</th>
                          <th class="px-4 py-3 font-semibold">Observações</th>
                          <th class="px-4 py-3 font-semibold text-right">
                            Ações
                          </th>
                        </tr>
                      </thead>
                      <tbody
                        id="manual-block-body"
                        class="divide-y divide-gray-100"
                      >
                        <!-- Injected JS -->
                      </tbody>
                    </table>
                  </div>
                  <div id="manual-block-cards" class="sm:hidden space-y-3">
                    <!-- Injected JS -->
                  </div>
                </div>
                <div
                  id="manual-block-empty"
                  class="hidden text-center text-gray-400 text-sm py-6"
                >
                  Nenhum período bloqueado manualmente.
                </div>
              </div>
            </div>
          </div>

          <!-- ALL RESERVATIONS VIEW -->
          <div id="section-all-reservations" class="hidden section-view">
            <div
              class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
            >
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                    <tr>
                      <th class="px-6 py-4 font-semibold">Data</th>
                      <th class="px-6 py-4 font-semibold">Cliente</th>
                      <th class="px-6 py-4 font-semibold">Status</th>
                      <th class="px-6 py-4 font-semibold">Contrato</th>
                    </tr>
                  </thead>
                  <tbody
                    id="all-table-body"
                    class="divide-y divide-gray-100 text-sm"
                  >
                    <!-- Injected JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- SIGNATURE MODAL -->
    <div
      id="signature-modal"
      class="fixed inset-0 z-[60] bg-black/60 hidden items-center justify-center backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden transform transition-all"
      >
        <div class="p-6 border-b border-gray-100">
          <h3 class="text-lg font-bold text-gray-900">Assinar Contrato</h3>
          <p class="text-sm text-gray-500">
            Confirme a reserva assinando abaixo.
          </p>
        </div>
        <div class="p-6 bg-gray-50">
          <div
            class="bg-white border-2 border-dashed border-gray-300 rounded-xl mb-4 shadow-sm"
          >
            <canvas
              id="signature-pad"
              class="w-full h-48 cursor-crosshair touch-none"
            ></canvas>
          </div>
          <button
            onclick="clearSignature()"
            class="text-sm text-red-500 hover:text-red-700 font-medium w-full text-center"
          >
            Limpar Assinatura
          </button>
        </div>
        <div
          class="p-6 border-t border-gray-100 bg-white flex justify-end gap-3"
        >
          <button
            onclick="closeModal()"
            class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 font-medium"
          >
            Cancelar
          </button>
          <button
            onclick="confirmSignature()"
            id="btn-confirm-sign"
            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-lg font-medium"
          >
            Confirmar Assinatura
          </button>
        </div>
      </div>
    </div>

    <!-- EDIT MODAL (IFRAME) -->
    <div
      id="edit-modal"
      class="fixed inset-0 z-[60] bg-black/60 hidden items-center justify-center backdrop-blur-sm p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-5xl w-full overflow-hidden"
      >
        <div
          class="p-4 border-b border-gray-100 flex items-center justify-between"
        >
          <h3 class="text-lg font-bold text-gray-900">Editar Reserva</h3>
          <button
            onclick="closeEditModal()"
            class="text-sm text-gray-500 hover:text-gray-700"
          >
            Fechar
          </button>
        </div>
        <div class="bg-gray-50">
          <iframe id="edit-iframe" class="w-full h-[80vh] bg-white"></iframe>
        </div>
      </div>
    </div>

    <!-- CONTRACT PREVIEW MODAL -->
    <div
      id="contract-preview-modal"
      class="fixed inset-0 z-[60] bg-black/60 hidden items-center justify-center backdrop-blur-sm p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-5xl w-full overflow-hidden"
      >
        <div
          class="p-4 border-b border-gray-100 flex items-center justify-between"
        >
          <h3
            id="contract-preview-title"
            class="text-lg font-bold text-gray-900"
          >
            Visualização do Contrato
          </h3>
          <div class="flex items-center gap-2">
            <button
              onclick="printContractPreview()"
              class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-sm"
            >
              Imprimir
            </button>
            <button
              onclick="closeContractPreview()"
              class="text-sm text-gray-500 hover:text-gray-700"
            >
              Fechar
            </button>
          </div>
        </div>
        <div class="bg-gray-50">
          <iframe
            id="contract-preview-frame"
            class="w-full h-[80vh] bg-white"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      const supabaseUrl = "https://nsdvyjihggmtbiusqkkp.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZHZ5amloZ2dtdGJpdXNxa2twIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjQ3NzIsImV4cCI6MjA4NjE0MDc3Mn0.KxxvVLFdz8YKL4c5DhUe5t6huIYtkn-YIMNitSM8hRE";

      // Fix: Use 'supabaseApp' to avoid conflict with global 'supabase' from CDN
      const supabaseApp = window.supabase.createClient(
        supabaseUrl,
        supabaseKey,
        {
          auth: { storageKey: "plenitur-admin-auth" },
        },
      );
      const ADMIN_EMAIL = "pleniturflats@gmail.com";
      const ADMIN_PASS = "Matheus01";
      const N8N_WEBHOOK_URL =
        "https://n8n.servmjr.site/webhook/plenitur-contrato";

      // --- STATE ---
      let allReservations = [];
      let manualDateBlocks = [];
      let currentReservationId = null;
      let currentEditReservationId = null;
      let currentManualBlockEditId = null;
      let currentDate = new Date();
      let contractPreviewObjectUrl = null;
      let occupancyRateChart = null;
      let financialChart = null;
      let signatureCanvas = null;
      let signatureCtx = null;
      let signatureDrawing = false;
      let calendarFiltersInitialized = false;
      let manualBlockFormInitialized = false;
      let calendarViewMode = "month";
      const calendarMonthNames = [
        "Janeiro",
        "Fevereiro",
        "Março",
        "Abril",
        "Maio",
        "Junho",
        "Julho",
        "Agosto",
        "Setembro",
        "Outubro",
        "Novembro",
        "Dezembro",
      ];

      // --- AUTHENTICATION ---
      function checkLogin() {
        const appContent = document.getElementById("app-content");
        const isLogged = localStorage.getItem("admin_logged");
        if (isLogged === "true") {
          document.getElementById("login-screen").classList.add("hidden");
          appContent.classList.remove("hidden");
          appContent.classList.add("flex");
          initDashboard();
        } else {
          document.getElementById("login-screen").classList.remove("hidden");
          appContent.classList.add("hidden");
          appContent.classList.remove("flex");
        }
      }

      function handleLogin(e) {
        e.preventDefault();
        const email = document
          .getElementById("email-input")
          .value.trim()
          .toLowerCase();
        const pass = document.getElementById("password-input").value;
        if (email === ADMIN_EMAIL && pass === ADMIN_PASS) {
          localStorage.setItem("admin_logged", "true");
          checkLogin();
        } else {
          document.getElementById("login-error").classList.remove("hidden");
        }
      }

      function logout() {
        localStorage.removeItem("admin_logged");
        location.reload();
      }

      // --- NAVIGATION ---
      let sidebarOpen = false;

      function openSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        if (!sidebar || !overlay) return;
        sidebar.classList.remove("-translate-x-full");
        sidebar.classList.add("translate-x-0");
        overlay.classList.remove("hidden");
        sidebarOpen = true;
      }

      function closeSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        if (!sidebar || !overlay) return;
        sidebar.classList.add("-translate-x-full");
        sidebar.classList.remove("translate-x-0");
        overlay.classList.add("hidden");
        sidebarOpen = false;
      }

      function toggleSidebar() {
        if (sidebarOpen) {
          closeSidebar();
        } else {
          openSidebar();
        }
      }

      function showSection(sectionId) {
        // Update UI
        document
          .querySelectorAll(".section-view")
          .forEach((el) => el.classList.add("hidden"));
        const sectionEl = document.getElementById(`section-${sectionId}`);
        if (sectionEl) {
          sectionEl.classList.remove("hidden");
        } else {
          console.warn("Seção não encontrada:", sectionId);
        }

        // Update Active Link
        document
          .querySelectorAll(".sidebar-link")
          .forEach((el) => el.classList.remove("active"));
        const navMap = {
          dashboard: "nav-dashboard",
          pending: "nav-pending",
          calendar: "nav-calendar",
          "all-reservations": "nav-all",
        };
        const navId = navMap[sectionId] || `nav-${sectionId}`;
        const navEl = document.getElementById(navId);
        if (navEl) navEl.classList.add("active");

        // Update Title
        const titles = {
          dashboard: "Visão Geral",
          pending: "Contratos Pendentes",
          calendar: "Calendário de Reservas",
          "all-reservations": "Histórico Completo",
        };
        const headerTitle = document.getElementById("page-title");
        if (headerTitle) headerTitle.innerText = titles[sectionId];
        const inlineTitle = document.getElementById("page-title-inline");
        if (inlineTitle) inlineTitle.innerText = titles[sectionId];

        if (window.innerWidth < 1024) {
          closeSidebar();
        }
      }

      // --- DATA FETCHING ---
      async function fetchAllData() {
        const reservationsPromise = supabaseApp
          .from("reservations")
          .select(
            "*, clients(full_name, cpf, rg, profession, phone, email, address_zip_code, address_street, address_number, address_district, address_city, address_state)",
          )
          .order("created_at", { ascending: false });
        const blocksPromise = supabaseApp
          .from("manual_date_blocks")
          .select("*")
          .order("start_date", { ascending: true });

        const [reservationsResult, blocksResult] = await Promise.all([
          reservationsPromise,
          blocksPromise,
        ]);

        if (reservationsResult.error) {
          console.error("Erro ao carregar reservas:", reservationsResult.error);
          allReservations = [];
        } else {
          allReservations = reservationsResult.data || [];
        }

        if (blocksResult.error) {
          // Table may not exist before migration; keep app usable.
          if (
            blocksResult.error.code !== "42P01" &&
            blocksResult.error.code !== "PGRST205"
          ) {
            console.error(
              "Erro ao carregar bloqueios manuais:",
              blocksResult.error,
            );
          }
          manualDateBlocks = [];
        } else {
          manualDateBlocks = blocksResult.data || [];
        }

        updateStats();
        renderNextArrivals();
        renderDashboardBlockedDates();
        renderDashboardCharts();
        renderPendingTable();
        renderAllTable();
        renderCalendar();
      }

      function formatCurrencyBR(value) {
        return new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(Number(value || 0));
      }

      function getReservationsCreatedInMonth(year, month) {
        return allReservations.filter((reservation) => {
          if (!reservation.created_at) return false;
          const status = String(reservation.status || "").toLowerCase();
          if (status === "cancelled" || status === "canceled") return false;
          const createdAt = new Date(reservation.created_at);
          return (
            createdAt.getFullYear() === year && createdAt.getMonth() === month
          );
        });
      }

      function getReservationFinancial(reservation) {
        const total =
          parseFloat(reservation.total_amount || reservation.total_value || 0) ||
          0;
        const deposit = parseFloat(reservation.deposit_amount || 0) || 0;
        const status = String(reservation.status || "").toLowerCase();
        const isCancelled = status === "cancelled" || status === "canceled";

        if (isCancelled) {
          return { total: 0, received: 0, receivable: 0 };
        }

        // Financial rule: assinatura/aprovação não significa quitação total.
        // Por padrão, considera recebido apenas o sinal.
        const hasDepositEvidence =
          reservation.deposit_paid === true ||
          !!reservation.deposit_date ||
          status === "pending_admin_signature" ||
          !!reservation.contract_signed_url;
        const isFullySettled =
          status === "completed" ||
          status === "closed" ||
          reservation.fully_paid === true ||
          reservation.full_paid === true;

        let received = 0;
        if (isFullySettled) {
          received = total;
        } else if (hasDepositEvidence) {
          received = Math.min(deposit, total);
        }

        return {
          total,
          received,
          receivable: Math.max(total - received, 0),
        };
      }

      function getOccupiedNightsForMonth(year, month) {
        const monthStart = new Date(year, month, 1);
        const monthEndExclusive = new Date(year, month + 1, 1);
        const occupiedNights = new Set();

        allReservations.forEach((reservation) => {
          if (!reservation.check_in || !reservation.check_out) return;
          const status = String(reservation.status || "").toLowerCase();
          if (status === "cancelled" || status === "canceled") return;

          const startDate = new Date(reservation.check_in + "T12:00:00");
          const endDate = new Date(reservation.check_out + "T12:00:00");

          if (endDate <= monthStart || startDate >= monthEndExclusive) return;

          const cursor = new Date(
            Math.max(startDate.getTime(), monthStart.getTime()),
          );
          const endLimit = new Date(
            Math.min(endDate.getTime(), monthEndExclusive.getTime()),
          );

          while (cursor < endLimit) {
            const key = `${cursor.getFullYear()}-${String(cursor.getMonth() + 1).padStart(2, "0")}-${String(cursor.getDate()).padStart(2, "0")}`;
            occupiedNights.add(key);
            cursor.setDate(cursor.getDate() + 1);
          }
        });

        return occupiedNights.size;
      }

      function getMonthlyOccupancy(year, month) {
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const occupiedNights = getOccupiedNightsForMonth(year, month);
        const rate = daysInMonth
          ? (occupiedNights / daysInMonth) * 100
          : 0;
        return { occupiedNights, daysInMonth, rate };
      }

      function updateStats() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const pendingCount = allReservations.filter(
          (reservation) =>
            !reservation.admin_signature_url &&
            (reservation.contract_signed_url ||
              reservation.status === "pending_admin_signature"),
        ).length;

        const monthReservations = getReservationsCreatedInMonth(
          currentYear,
          currentMonth,
        );

        let monthTotal = 0;
        let monthReceived = 0;
        let monthReceivable = 0;
        monthReservations.forEach((reservation) => {
          const financial = getReservationFinancial(reservation);
          monthTotal += financial.total;
          monthReceived += financial.received;
          monthReceivable += financial.receivable;
        });

        const occupancy = getMonthlyOccupancy(currentYear, currentMonth);

        const statPending = document.getElementById("stat-pending");
        const statMonth = document.getElementById("stat-month");
        const statRevenue = document.getElementById("stat-revenue");
        const statReceived = document.getElementById("stat-received");
        const statReceivable = document.getElementById("stat-receivable");
        const statOccupancy = document.getElementById("stat-occupancy");
        const statOccupancyDetail = document.getElementById(
          "stat-occupancy-detail",
        );

        if (statPending) statPending.innerText = String(pendingCount);
        if (statMonth) statMonth.innerText = String(monthReservations.length);
        if (statRevenue) statRevenue.innerText = formatCurrencyBR(monthTotal);
        if (statReceived) statReceived.innerText = formatCurrencyBR(monthReceived);
        if (statReceivable)
          statReceivable.innerText = formatCurrencyBR(monthReceivable);
        if (statOccupancy)
          statOccupancy.innerText = `${occupancy.rate.toFixed(1)}%`;
        if (statOccupancyDetail) {
          statOccupancyDetail.innerText = `${occupancy.occupiedNights} de ${occupancy.daysInMonth} noites ocupadas`;
        }

        const badge = document.getElementById("pending-badge");
        if (badge) {
          if (pendingCount > 0) {
            badge.innerText = pendingCount;
            badge.classList.remove("hidden");
          } else {
            badge.classList.add("hidden");
          }
        }
      }

      function renderDashboardCharts() {
        if (typeof Chart === "undefined") return;
        const occupancyCanvas = document.getElementById("dashboard-occupancy-chart");
        const financialCanvas = document.getElementById("dashboard-financial-chart");
        if (!occupancyCanvas || !financialCanvas) return;

        const currentYear = new Date().getFullYear();
        const labels = calendarMonthNames.map((name) => name.slice(0, 3));

        const occupancyData = [];
        const receivedData = [];
        const receivableData = [];

        for (let month = 0; month < 12; month++) {
          const occupancy = getMonthlyOccupancy(currentYear, month);
          occupancyData.push(Number(occupancy.rate.toFixed(1)));

          const monthReservations = getReservationsCreatedInMonth(currentYear, month);
          let received = 0;
          let receivable = 0;
          monthReservations.forEach((reservation) => {
            const financial = getReservationFinancial(reservation);
            received += financial.received;
            receivable += financial.receivable;
          });

          receivedData.push(Number(received.toFixed(2)));
          receivableData.push(Number(receivable.toFixed(2)));
        }

        if (occupancyRateChart) {
          occupancyRateChart.destroy();
        }
        if (financialChart) {
          financialChart.destroy();
        }

        occupancyRateChart = new Chart(occupancyCanvas, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Ocupação (%)",
                data: occupancyData,
                borderColor: "#2563eb",
                backgroundColor: "rgba(37, 99, 235, 0.12)",
                fill: true,
                tension: 0.3,
                pointRadius: 3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { callback: (value) => `${value}%` },
              },
            },
          },
        });

        financialChart = new Chart(financialCanvas, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Recebido",
                data: receivedData,
                backgroundColor: "rgba(5, 150, 105, 0.75)",
                borderRadius: 8,
              },
              {
                label: "A receber",
                data: receivableData,
                backgroundColor: "rgba(217, 119, 6, 0.75)",
                borderRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (context) =>
                    `${context.dataset.label}: ${formatCurrencyBR(context.parsed.y)}`,
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => formatCurrencyBR(value),
                },
              },
            },
          },
        });
      }

      function editManualBlockFromDashboard(id) {
        showSection("calendar");
        setTimeout(() => editManualBlock(id), 80);
      }

      function renderDashboardBlockedDates() {
        const list = document.getElementById("dashboard-blocked-list");
        const countLabel = document.getElementById("dashboard-blocked-count");
        if (!list || !countLabel) return;

        const todayIso = getTodayIsoDate();
        const activeBlocks = manualDateBlocks
          .filter((block) => block.is_active && block.end_date >= todayIso)
          .sort((a, b) => new Date(a.start_date) - new Date(b.start_date));

        countLabel.innerText = `${activeBlocks.length} ativo${activeBlocks.length === 1 ? "" : "s"}`;
        list.innerHTML = "";

        if (!activeBlocks.length) {
          list.innerHTML =
            '<p class="text-gray-400 text-center py-4">Nenhuma data indisponível ativa.</p>';
          return;
        }

        activeBlocks.slice(0, 6).forEach((block) => {
          const reference = escapeHtml(
            block.client_name || "Indisponível manual",
          );
          const notes = escapeHtml(block.notes || "Sem observações");
          const period = `${formatShortDateBR(block.start_date)} → ${formatShortDateBR(block.end_date)}`;

          list.innerHTML += `
            <div class="p-3 rounded-lg border border-gray-100 hover:bg-gray-50 transition">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <p class="font-semibold text-gray-900 truncate">${reference}</p>
                  <p class="text-xs text-gray-500 mt-1">${period}</p>
                  <p class="text-xs text-gray-500 mt-1 truncate">${notes}</p>
                </div>
                <div class="flex flex-wrap justify-end gap-2">
                  <button onclick="editManualBlockFromDashboard('${block.id}')" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-blue-50 text-blue-700 hover:bg-blue-100">Editar</button>
                  <button onclick="toggleManualBlockStatus('${block.id}', false)" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-emerald-50 text-emerald-700 hover:bg-emerald-100">Disponibilizar</button>
                  <button onclick="deleteManualBlock('${block.id}')" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-red-50 text-red-700 hover:bg-red-100">Excluir</button>
                </div>
              </div>
            </div>
          `;
        });

        if (activeBlocks.length > 6) {
          list.innerHTML += `
              <p class="text-xs text-gray-500 text-right">
              Mostrando 6 de ${activeBlocks.length} indisponibilidades ativas.
              </p>
            `;
        }
      }

      // --- RENDERING ---
      function renderNextArrivals() {
        // Filter future checkins, sort by date
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const upcoming = allReservations
          .filter((r) => new Date(r.check_in + "T12:00:00") >= today)
          .sort((a, b) => new Date(a.check_in) - new Date(b.check_in))
          .slice(0, 3); // Top 3

        const list = document.getElementById("next-arrivals-list");
        list.innerHTML = "";

        if (upcoming.length === 0) {
          list.innerHTML =
            '<p class="text-gray-400 text-center py-4">Nenhum check-in próximo.</p>';
          return;
        }

        upcoming.forEach((res) => {
          const date = new Date(res.check_in + "T12:00:00").toLocaleDateString(
            "pt-BR",
            { day: "2-digit", month: "short" },
          );

          // Status Logic
          let statusLabel = "Pendente";
          let statusClass = "bg-yellow-100 text-yellow-700";

          if (res.admin_signature_url) {
            statusLabel = "Confirmado";
            statusClass = "bg-green-100 text-green-700";
          } else if (res.contract_signed_url) {
            statusLabel = "Assinado (Cliente)";
            statusClass = "bg-blue-100 text-blue-700";
          }

          const canFinalPdf = !!res.admin_signature_url;

          list.innerHTML += `
                    <div class="flex flex-col sm:flex-row sm:items-center p-3 hover:bg-gray-50 rounded-lg transition border border-gray-100">
                        <div class="bg-blue-100 text-blue-600 font-bold rounded-lg h-12 w-12 flex flex-col items-center justify-center text-xs leading-tight">
                            <span class="text-lg">${date.split(" ")[0]}</span>
                            <span class="uppercase text-[0.6rem]">${date.split(" ")[2]}</span>
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 flex-1 min-w-0">
                            <p class="font-bold text-gray-900 truncate">${res.clients?.full_name || "Hóspede"}</p>
                            <p class="text-xs text-gray-500">
                                Entrada: ${new Date(res.check_in + "T12:00:00").toLocaleDateString("pt-BR")} ·
                                Saída: ${new Date(res.check_out + "T12:00:00").toLocaleDateString("pt-BR")}
                            </p>
                        </div>
                        <div class="mt-3 sm:mt-0 sm:ml-2 w-full sm:w-auto flex flex-wrap items-center justify-between sm:justify-end gap-2">
                             <span class="px-2 py-1 ${statusClass} text-xs font-bold rounded-full whitespace-nowrap">${statusLabel}</span>
                             <button onclick="openContractPreview('${res.id}')" class="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                 <i data-lucide="file-text" class="w-3 h-3"></i> Visualizar
                             </button>
                             <button onclick="openFinalPdf('${res.id}')" ${canFinalPdf ? "" : "disabled"} class="text-xs ${canFinalPdf ? "text-blue-600 hover:underline" : "text-gray-400"}">
                                 PDF Final
                             </button>
                        </div>
                    </div>
                `;
        });
        lucide.createIcons();
      }

      function renderPendingTable() {
        // Logic: Show any reservation missing admin signature, especially if client signed
        const pending = allReservations.filter(
          (r) =>
            !r.admin_signature_url &&
            (r.contract_signed_url ||
              r.status === "pending_admin_signature" ||
              !r.status),
        );

        const tbody = document.getElementById("pending-table-body");
        const empty = document.getElementById("pending-empty");

        tbody.innerHTML = "";

        if (pending.length === 0) {
          empty.classList.remove("hidden");
          return;
        }
        empty.classList.add("hidden");

        pending.forEach((res) => {
          tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition border-b border-gray-50">
                        <td class="px-6 py-4">
                            <p class="font-bold text-gray-900">${res.clients?.full_name}</p>
                            <p class="text-xs text-gray-400">#${res.id.slice(0, 6)}</p>
                        </td>
                        <td class="px-6 py-4 text-gray-600 text-xs">
                            ${new Date(res.check_in).toLocaleDateString()} <br/> -> ${new Date(res.check_out).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 font-bold text-gray-700 text-sm">
                            R$ ${parseFloat(res.total_amount || res.total_value || 0).toFixed(2)}
                        </td>
                        <td class="px-6 py-4 text-right flex justify-end items-center gap-2">
                            <button onclick="openContractPreview('${res.id}')" title="Ver Contrato (Formatado)"
                                class="p-2 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-indigo-600 transition">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                            </button>
                            <button onclick="openContractPreview('${res.id}', true)" title="Imprimir/Salvar PDF"
                                class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 transition">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                            </button>
                            ${
                              res.contract_signed_url
                                ? `
                                <a href="${res.contract_signed_url}" download="Contrato_${res.id}.pdf" title="Baixar PDF original"
                                   class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 transition">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </a>
                            `
                                : ""
                            }
                            
                            <button onclick="editReservation('${res.id}')" title="Editar"
                                class="p-2 bg-blue-50 hover:bg-blue-100 rounded-lg text-blue-600 transition">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>

                            <button onclick="openSignModal('${res.id}')" class="flex items-center gap-2 bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-green-700 transition">
                                <i data-lucide="pen-tool" class="w-3 h-3"></i> Assinar
                            </button>
                        </td>
                    </tr>
                 `;
        });
        lucide.createIcons();
      }

      function editReservation(id) {
        openEditModal(id);
      }

      function openEditModal(id) {
        currentEditReservationId = id;
        const iframe = document.getElementById("edit-iframe");
        iframe.src = `index.html?edit=${id}&admin=1&embed=1`;
        document.getElementById("edit-modal").classList.remove("hidden");
        document.getElementById("edit-modal").classList.add("flex");
      }

      function closeEditModal() {
        const iframe = document.getElementById("edit-iframe");
        iframe.src = "about:blank";
        document.getElementById("edit-modal").classList.add("hidden");
        document.getElementById("edit-modal").classList.remove("flex");
        currentEditReservationId = null;
      }

      function renderAllTable() {
        const tbody = document.getElementById("all-table-body");
        tbody.innerHTML = "";

        allReservations.forEach((res) => {
          let statusHtml = "";
          if (res.admin_signature_url) {
            statusHtml =
              '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Aprovado</span>';
          } else {
            statusHtml =
              '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">Pendente</span>';
          }

          tbody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 text-gray-500">${new Date(res.created_at).toLocaleDateString("pt-BR")}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${res.clients?.full_name}</td>
                        <td class="px-6 py-4">${statusHtml}</td>
                        <td class="px-6 py-4">
                             <button onclick="openContractPreview('${res.id}')" class="inline-flex items-center gap-1 text-indigo-600 hover:underline text-xs mr-3">
                                 <i data-lucide="file-text" class="w-3 h-3"></i> Visualizar
                             </button>
                             <button onclick="openFinalPdf('${res.id}')" class="text-blue-600 hover:underline text-xs ${res.admin_signature_url ? "" : "opacity-50 cursor-not-allowed"}" ${res.admin_signature_url ? "" : "disabled"}>
                                 PDF Final
                             </button>
                        </td>
                    </tr>
                 `;
        });
        lucide.createIcons();
      }

      // --- CONTRACT GENERATION ---
      function formatDateBR(dateStr) {
        return dateStr
          ? dateStr.split("-").reverse().join("/")
          : "___/___/______";
      }

      function buildInstallmentsText(res) {
        let paymentDetails = res.payment_details;
        if (typeof paymentDetails === "string") {
          try {
            paymentDetails = JSON.parse(paymentDetails);
          } catch (e) {
            paymentDetails = null;
          }
        }
        const schedule = paymentDetails?.schedule;
        if (Array.isArray(schedule) && schedule.length > 0) {
          let text = `\n\nPARCELAMENTO (CRONOGRAMA):`;
          schedule.forEach((item, index) => {
            const parcelNum = item.parcel || index + 1;
            const label =
              parcelNum === 1
                ? "1ª Parcela (Reserva)"
                : `${parcelNum}ª Parcela`;
            const amount = Number(item.amount || 0).toFixed(2);
            const date = item.date ? formatDateBR(item.date) : "___/___/______";
            text += `\n\n${label}: R$ ${amount} — vencimento: ${date}`;
          });
          text += `\n\nCondição prática (recomendado): a entrega das chaves/check-in fica condicionada à quitação das parcelas vencidas até a data e à comprovação do pagamento.`;
          return text;
        }

        const numRemaining = Number(res.installments) || 0;
        if (numRemaining > 0) {
          let text = `\n\nPARCELAMENTO (CRONOGRAMA):\n\n1ª Parcela (Reserva): R$ ${Number(res.deposit_amount || 0).toFixed(2)} — paga no ato da reserva`;
          for (let i = 2; i <= numRemaining + 1; i++) {
            text += `\n\n${i}ª Parcela: R$ 0,00 — vencimento: ___/___/______`;
          }
          text += `\n\nCondição prática (recomendado): a entrega das chaves/check-in fica condicionada à quitação das parcelas vencidas até a data e à comprovação do pagamento.`;
          return text;
        }
        return "";
      }

      function buildContractHTML(res, options = {}) {
        const client = res.clients || {};
        const endereco = `${client.address_street || "________________________"}, ${client.address_number || "___"}${client.address_district ? ", " + client.address_district : ""}, ${client.address_city || "________________"} - ${client.address_state || "__"}, CEP ${client.address_zip_code || "_____-___"}`;
        const valorRestante = (
          Number(res.total_amount || 0) - Number(res.deposit_amount || 0)
        ).toFixed(2);
        const parcelasTexto = buildInstallmentsText(res);
        const hasPet = res.has_pet === true || res.has_pet === "Sim";
        const clientSignatureUrl = options.clientSignatureUrl || null;
        const adminSignatureUrl = options.adminSignatureUrl || null;
        const showSignatures = options.showSignatures !== false;
        const autoPrint = options.autoPrint === true;

        return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Contrato de Locação por Temporada</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.6; padding: 40px 60px; max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; font-size: 16pt; margin-bottom: 30px; text-transform: uppercase; }
        h2 { font-size: 12pt; margin-top: 25px; margin-bottom: 10px; }
        p { text-align: justify; margin: 10px 0; }
        ul { margin: 10px 0 10px 20px; }
        li { margin: 3px 0; }
        .signatures { margin-top: 60px; display: flex; justify-content: space-between; gap: 24px; }
        .signature-line { width: 48%; text-align: center; }
        .signature-line hr { border: none; border-top: 1px solid #000; margin-bottom: 5px; }
        .signature-img { max-height: 90px; display: block; margin: 0 auto 8px; }
        .signature-space { height: 90px; }
        .highlight { background-color: #ffffcc; padding: 2px 5px; }
        @media print { body { padding: 20px; } }
    </style>
</head>
<body>
    <h1>CONTRATO DE LOCAÇÃO POR TEMPORADA</h1>

    <p><strong>LOCADOR:</strong> N C DA SILVA - PLENITUR ALUGUEL POR TEMPORADA SERV, inscrita no CNPJ sob nº 09.287.000/0001-99, com sede em Avenida Bahia, 644, Sala C Cx postal 140, Bairro dos Estados, João Pessoa - PB, CEP 58.030-130.</p>

    <p><strong>LOCATÁRIO:</strong> <span class="highlight">${client.full_name || "________________________"}</span>, inscrito no CPF nº <span class="highlight">${client.cpf || "___.___.___-__"}</span>, RG nº <span class="highlight">${client.rg || "____________"}</span>, profissão <span class="highlight">${client.profession || "____________"}</span>, residente e domiciliado em <span class="highlight">${endereco}</span>, e-mail <span class="highlight">${client.email || "____________"}</span>.</p>

    <h2>1. OBJETO DO CONTRATO</h2>
    <p>O objeto do presente contrato é a locação temporária do Flat Beach Haus, situado na Av. Gov. Argemiro de Figueiredo, 280 - Jardim Oceania, João Pessoa - PB, 58.037-030. Flat totalmente equipado e possui as seguintes descrições:</p>
    <ul>
        <li>Uma cama queen, um sofá cama</li>
        <li>Um frigobar, um microondas, um Air fryer</li>
        <li>Uma panela elétrica de arroz, uma cafeteira elétrica</li>
        <li>Um liquidificador, uma sanduicheira elétrica</li>
        <li>Quatro pratos de jantar, quatro pratos de sobremesa, quatro xícaras com pires</li>
        <li>Quatro taças, quatro copos, Talheres, uma faca de cozinha, toalhas de banho</li>
        <li>Toalhas de rosto, lençois para cama e para sofá cama</li>
        <li>Cobertores, seis travesseiros, duas almofadas e uma manta decorativa para sofá</li>
        <li>Um quadro de parede</li>
    </ul>

    <h2>2. PRAZO E PERÍODO DE LOCAÇÃO</h2>
    <p>A locação será realizada com início em <strong><span class="highlight">${formatDateBR(res.check_in)}</span></strong> às <strong><span class="highlight">${res.check_in_time || "14:00"}</span></strong> e término em <strong><span class="highlight">${formatDateBR(res.check_out)}</span></strong> às <strong><span class="highlight">${res.check_out_time || "12:00"}</span></strong>.</p>

    <h2>3. VALOR E FORMA DE PAGAMENTO</h2>
    <p>O valor total da locação é de <strong>R$ <span class="highlight">${Number(res.total_amount || 0).toFixed(2)}</span></strong>.</p>

    <p>O pagamento será realizado de forma parcelada, da seguinte maneira:</p>
    <p>a) <strong>R$ <span class="highlight">${Number(res.deposit_amount || 0).toFixed(2)}</span></strong> no ato da reserva (1ª parcela), via Pix (chave e-mail): <strong>neomarlondon@hotmail.com</strong>;</p>
    <p>b) o saldo remanescente de <strong>R$ <span class="highlight">${valorRestante}</span></strong> será pago conforme o cronograma de parcelas abaixo.</p>

    ${parcelasTexto ? `<p style="white-space: pre-line;">${parcelasTexto}</p>` : ""}
    <p style="margin-top: 20px;">O valor contratado é referente a locação para o total de <strong><span class="highlight">${res.guests_count || "1"}</span></strong> pessoas.</p>
    <p>Será cobrado o valor de R$500,00 (quinhentos reais) a título de caução para sanar qualquer dano que porventura venha ocorrer no flat. Esse valor será depositado no dia da entrada e devolvido na saída do flat.</p>
    ${hasPet ? `<p><strong>Obs.:</strong> Pets só serão aceitos mediante a uma taxa extra de R$180,00 (já inclusa no valor total).</p>` : ""}

    <h2>4. RESPONSABILIDADES DO LOCATÁRIO</h2>
    <h3>4.1. Vistoria do imóvel e regras do condomínio:</h3>
    <p>No momento da entrega das chaves, será realizada uma vistoria detalhada do imóvel, a fim de verificar suas condições. Qualquer divergência deverá ser registrada em documento, assinado por ambas as partes.</p>
    
    <p><strong>RECEPÇÃO</strong></p>
    <ul>
        <li>Check-in e Check-out devem ser feitos na portaria</li>
        <li>Cadastro de biometria facial.</li>
        <li>Não é permitido receber visitas.</li>
    </ul>

    <p><strong>GARAGEM</strong></p>
    <ul>
        <li>Vagas rotativas mediante disponibilidade. VAGAS AMARELAS.</li>
        <li>Carregador elétrico (consultar disponibilidade na portaria).</li>
        <li>Não pegue carona na abertura do portão.</li>
    </ul>

    <p><strong>LAVANDERIA</strong></p>
    <ul>
        <li>Aberto das 07h às 22h</li>
        <li>Deve-se usar 1 máquina por vez.</li>
        <li>Proibido utilizar sabão em pó.</li>
    </ul>

    <p><strong>ACADEMIA</strong></p>
    <ul>
        <li>Aberto das 07h às 22h</li>
        <li>Não solte os pesos bruscamente no chão.</li>
        <li>Mantenha sempre organizada.</li>
    </ul>

    <p><strong>SALA DE REUNIÃO / COWORKING</strong></p>
    <ul>
        <li>Aberto das 07h às 22h</li>
        <li>Uso livre por ordem de chegada, sem reserva antecipada.</li>
        <li>Sala climatizada ❄️</li>
    </ul>

    <p><strong>BRINQUEDOTECA</strong></p>
    <ul>
        <li>Aberto das 07h às 22h</li>
        <li>Pegar a chave na portaria.</li>
        <li>A criança menor de 12 anos precisa estar acompanhada do responsável.</li>
        <li>Lei Estadual 13.087/2024 – PB</li>
    </ul>

    <p><strong>PISCINA E ÁREA GOURMET</strong></p>
    <ul>
        <li>Aberto das 06h às 22h</li>
        <li>Proibido itens de vidro nas mesas do deck.</li>
        <li>Não leve alimentos ou bebidas para as bordas da piscina.</li>
    </ul>

    <p><strong>ÁREAS COMUNS / LIXO</strong></p>
    <ul>
        <li>Proibido circular sem camisa e com traje de banho (sunga/biquini).</li>
        <li>Dispensar o lixo nas escadas.</li>
        <li>Proibido fumar em qualquer área do condomínio.</li>
        <li>Horário Acesso Praia: 06h às 20h</li>
    </ul>

    <p><strong>RESTAURANTE</strong></p>
    <ul>
        <li>Aberto das 07h às 10h30</li>
        <li>Apenas café da manhã</li>
        <li>Consultar valores no restaurante</li>
    </ul>

    <p>Contato: portariabeachhaus@gmail.com | WhatsApp: +55 83 98774-2593</p>

    <h3>4.2. Zelo pela Propriedade:</h3>
    <p>O locatário se compromete a zelar pelo imóvel, pelos móveis e pelos equipamentos disponíveis, utilizando-os de maneira adequada. Qualquer dano causado ao imóvel, móveis ou itens decorativos durante o período de locação será de responsabilidade do locatário, devendo este arcar com os custos de reparo ou substituição.</p>

    <h2>5. RESCISÃO E CANCELAMENTO</h2>
    <h3>5.1. Cancelamento por parte do Locatário:</h3>
    <ul>
        <li>Cancelamento com mais de 30 dias de antecedência: Reembolso total do valor da confirmação de reserva.</li>
        <li>Cancelamento entre 7 e 30 dias de antecedência: Reembolso de 50% do valor da confirmação da reserva.</li>
        <li>Cancelamento com menos de 7 dias de antecedência: Não há reembolso do valor da confirmação.</li>
    </ul>
    <p>Em caso de cancelamento por parte do locatário e dentro dos prazos estipulados acima, a locadora terá o prazo de 20 dias úteis para a devolução do valor pago.</p>

    <h3>5.2. Cancelamento por parte do Locador:</h3>
    <p>Caso o imóvel se torne indisponível por motivos imprevistos ou problemas estruturais, o locador oferecerá reembolso total ou alternativas de acomodação similar.</p>

    <h3>5.3. Política de Alteração de Reservas:</h3>
    <ul>
        <li>Alterações de datas estão sujeitas à disponibilidade e podem estar sujeitas a taxas adicionais.</li>
        <li>O locatário deve notificar o locador o mais cedo possível sobre qualquer alteração desejada.</li>
        <li>Todas as solicitações de cancelamento ou alteração devem ser feitas por escrito.</li>
    </ul>

    <h2>6. CONDIÇÕES GERAIS</h2>
    <ul>
        <li>Quaisquer reembolsos estão sujeitos a taxas de serviço.</li>
        <li>O imóvel será entregue em perfeitas condições de uso e deve ser devolvido nas mesmas condições de limpeza e conservação.</li>
        <li>Não é permitido realizar eventos ou festas no local sem autorização prévia. Sempre respeitar a Lei do Silêncio.</li>
        <li>É estritamente proibido o uso de drogas ou atividades ilícitas no imóvel.</li>
    </ul>

    <h2>7. FORO</h2>
    <p>Fica eleito o foro da comarca de João Pessoa/PB para dirimir quaisquer questões oriundas deste contrato.</p>

    <p style="margin-top: 40px;">João Pessoa, ${new Date().toLocaleDateString("pt-BR")}.</p>

    ${
      showSignatures
        ? `
    <div class="signatures">
        <div class="signature-line">
            <h3>LOCATÁRIO</h3>
            ${clientSignatureUrl ? `<img src="${clientSignatureUrl}" class="signature-img" />` : `<div class="signature-space"></div>`}
            <hr>
            <p><strong>${client.full_name || "________________________"}</strong></p>
        </div>
        <div class="signature-line">
            <h3>LOCADOR</h3>
            ${adminSignatureUrl ? `<img src="${adminSignatureUrl}" class="signature-img" />` : `<div class="signature-space"></div>`}
            <hr>
            <p><strong>N C DA SILVA - PLENITUR</strong></p>
        </div>
    </div>
    `
        : ""
    }

    ${autoPrint ? `<script>window.print();<\/script>` : ""}
</body>
</html>
`;
      }

      function createContractContainerFromHtml(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        doc.querySelectorAll("script").forEach((s) => s.remove());

        const container = document.createElement("div");
        container.style.position = "absolute";
        container.style.left = "-9999px";
        container.style.top = "0";
        container.style.width = "794px";
        container.style.background = "#ffffff";

        const styleEl = doc.querySelector("style");
        if (styleEl) {
          const styleNode = document.createElement("style");
          const cssText = styleEl.textContent || "";
          styleNode.textContent = cssText.replace(
            /\bbody\b/g,
            ".contract-body",
          );
          container.appendChild(styleNode);
        }

        const bodyWrapper = document.createElement("div");
        bodyWrapper.className = "contract-body";
        bodyWrapper.innerHTML = doc.body.innerHTML;
        container.appendChild(bodyWrapper);

        document.body.appendChild(container);
        return container;
      }

      async function renderContainerToPdfBlob(container) {
        const canvas = await html2canvas(container, {
          scale: 2,
          useCORS: true,
          backgroundColor: "#ffffff",
          windowWidth: 794,
        });

        const pdf = new jspdf.jsPDF("p", "pt", "a4");
        const pageWidthPt = pdf.internal.pageSize.getWidth();
        const pageHeightPt = pdf.internal.pageSize.getHeight();
        const pageHeightPx = Math.floor(
          canvas.width * (pageHeightPt / pageWidthPt),
        );

        let y = 0;
        let pageIndex = 0;

        while (y < canvas.height) {
          const pageCanvas = document.createElement("canvas");
          pageCanvas.width = canvas.width;
          pageCanvas.height = Math.min(pageHeightPx, canvas.height - y);
          const ctx = pageCanvas.getContext("2d");
          ctx.drawImage(canvas, 0, -y);

          const imgData = pageCanvas.toDataURL("image/jpeg", 0.98);
          if (pageIndex > 0) pdf.addPage();
          const imgHeightPt =
            (pageCanvas.height * pageWidthPt) / pageCanvas.width;
          pdf.addImage(imgData, "JPEG", 0, 0, pageWidthPt, imgHeightPt);

          y += pageHeightPx;
          pageIndex += 1;
        }

        const blob = pdf.output("blob");
        if (container && container.parentNode) {
          container.parentNode.removeChild(container);
        }
        return blob;
      }

      function openContractPreview(id, autoPrint = false) {
        const reservation = allReservations.find((r) => r.id === id);
        if (!reservation) {
          alert("Reserva não encontrada.");
          return;
        }
        if (contractPreviewObjectUrl) {
          URL.revokeObjectURL(contractPreviewObjectUrl);
          contractPreviewObjectUrl = null;
        }
        const html = buildContractHTML(reservation, {
          clientSignatureUrl: reservation.signature_url,
          adminSignatureUrl: reservation.admin_signature_url,
          showSignatures: true,
          autoPrint: false,
        });

        const frame = document.getElementById("contract-preview-frame");
        frame.src = "about:blank";
        frame.onload = () => {
          if (autoPrint && frame.contentWindow) {
            frame.contentWindow.print();
          }
        };
        frame.srcdoc = html;

        document.getElementById("contract-preview-title").innerText =
          "Visualização do Contrato";
        document
          .getElementById("contract-preview-modal")
          .classList.remove("hidden");
        document.getElementById("contract-preview-modal").classList.add("flex");
      }

      async function openFinalPdf(id) {
        const reservation = allReservations.find((r) => r.id === id);
        if (!reservation) {
          alert("Reserva não encontrada.");
          return;
        }
        if (!reservation.admin_signature_url) {
          alert("Contrato ainda não assinado pelo administrador.");
          return;
        }

        try {
          document.getElementById("contract-preview-title").innerText =
            "Gerando PDF Final...";

          const clientSigData = await urlToDataUrl(
            reservation.signature_url,
          ).catch(() => null);
          const adminSigData = await urlToDataUrl(
            reservation.admin_signature_url,
          ).catch(() => null);

          const contractHTML = buildContractHTML(reservation, {
            clientSignatureUrl: clientSigData || reservation.signature_url,
            adminSignatureUrl: adminSigData || reservation.admin_signature_url,
            showSignatures: true,
          });

          const container = createContractContainerFromHtml(contractHTML);
          const pdfBlob = await renderContainerToPdfBlob(container);

          const safeName =
            slugifyName(reservation.clients?.full_name) || "cliente";
          const filename = `final_contract_${safeName}_${reservation.id}_${Date.now()}.pdf`;
          const { error } = await supabaseApp.storage
            .from("contracts")
            .upload(filename, pdfBlob);
          if (error) throw error;

          const publicUrl = supabaseApp.storage
            .from("contracts")
            .getPublicUrl(filename).data.publicUrl;
          await supabaseApp
            .from("reservations")
            .update({ final_contract_url: publicUrl })
            .eq("id", reservation.id);
          await fetchAllData();

          const frame = document.getElementById("contract-preview-frame");
          frame.src = "about:blank";
          if (contractPreviewObjectUrl)
            URL.revokeObjectURL(contractPreviewObjectUrl);
          contractPreviewObjectUrl = URL.createObjectURL(pdfBlob);
          frame.srcdoc = `
<!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="UTF-8"><style>html,body{margin:0;height:100%;}</style></head>
<body>
<embed src="${contractPreviewObjectUrl}" type="application/pdf" width="100%" height="100%"/>
</body>
</html>`;

          document.getElementById("contract-preview-title").innerText =
            "PDF Final";
          document
            .getElementById("contract-preview-modal")
            .classList.remove("hidden");
          document
            .getElementById("contract-preview-modal")
            .classList.add("flex");
        } catch (e) {
          console.error(e);
          alert("Erro ao gerar PDF final: " + e.message);
        }
      }

      function closeContractPreview() {
        const frame = document.getElementById("contract-preview-frame");
        frame.srcdoc = "";
        frame.src = "about:blank";
        if (contractPreviewObjectUrl) {
          URL.revokeObjectURL(contractPreviewObjectUrl);
          contractPreviewObjectUrl = null;
        }
        document
          .getElementById("contract-preview-modal")
          .classList.add("hidden");
        document
          .getElementById("contract-preview-modal")
          .classList.remove("flex");
      }

      function printContractPreview() {
        const frame = document.getElementById("contract-preview-frame");
        if (frame && frame.contentWindow) {
          frame.contentWindow.print();
        }
      }

      async function urlToDataUrl(url) {
        if (!url) return null;
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      function normalizePhone(value) {
        return (value || "").replace(/\D/g, "");
      }

      function slugifyName(value) {
        return (value || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-zA-Z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "")
          .toLowerCase();
      }

      async function sendWhatsAppViaN8n({
        pdfUrl,
        contractId,
        clientName,
        clientPhone,
        companyPhone,
        filename,
        sendToClient,
        source,
        checkinDate,
        checkoutDate,
      }) {
        if (
          !N8N_WEBHOOK_URL ||
          N8N_WEBHOOK_URL.includes("SEU_WEBHOOK_N8N_AQUI")
        ) {
          return { success: false, error: "Webhook do n8n não configurado." };
        }

        try {
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contract_id: contractId,
              client_name: clientName || "",
              client_phone: clientPhone || "",
              company_phone: companyPhone || "",
              filename,
              pdf_url: pdfUrl,
              send_to_client: !!sendToClient,
              checkin_date: checkinDate || "",
              checkout_date: checkoutDate || "",
              source,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            throw new Error(errText || "Falha ao acionar o webhook do n8n");
          }

          return { success: true };
        } catch (e) {
          return { success: false, error: e.message };
        }
      }

      async function generateFinalContractPdf(res, adminSignatureDataUrl) {
        if (!adminSignatureDataUrl)
          throw new Error("Assinatura do administrador ausente.");

        const clientSignatureDataUrl = await urlToDataUrl(res.signature_url);
        const contractHTML = buildContractHTML(res, {
          clientSignatureUrl: clientSignatureDataUrl,
          adminSignatureUrl: adminSignatureDataUrl,
          showSignatures: true,
        });

        const container = createContractContainerFromHtml(contractHTML);
        const pdfBlob = await renderContainerToPdfBlob(container);

        const safeName = slugifyName(res.clients?.full_name) || "cliente";
        const filename = `final_contract_${safeName}_${res.id}_${Date.now()}.pdf`;
        const { error } = await supabaseApp.storage
          .from("contracts")
          .upload(filename, pdfBlob);

        if (error) throw error;

        const publicUrl = supabaseApp.storage
          .from("contracts")
          .getPublicUrl(filename).data.publicUrl;
        return publicUrl;
      }

      async function sendFinalContractEmail(
        reservation,
        finalContractUrl,
        adminSignatureUrl,
        overrideEmail = null,
        overrideName = null,
      ) {
        const email = overrideEmail || reservation.clients?.email;
        const name =
          overrideName || reservation.clients?.full_name || "Cliente";
        if (!email) {
          return { success: false, error: "Email do cliente não encontrado." };
        }

        try {
          const response = await fetch(
            `${supabaseUrl}/functions/v1/send-contract-email`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${supabaseKey}`,
              },
              body: JSON.stringify({
                email,
                name,
                contract_signed_url: finalContractUrl,
                signature_url: adminSignatureUrl || reservation.signature_url,
              }),
            },
          );

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || "Falha ao enviar email");
          }

          return { success: true };
        } catch (e) {
          return { success: false, error: e.message };
        }
      }

      function escapeHtml(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatShortDateBR(dateStr) {
        if (!dateStr) return "--";
        return new Date(dateStr + "T12:00:00").toLocaleDateString("pt-BR");
      }

      function getTodayIsoDate() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;
      }

      function isManualBlocksTableMissing(error) {
        if (!error) return false;
        return error.code === "PGRST205" || error.code === "42P01";
      }

      function showManualBlocksTableMissingAlert() {
        alert(
          "A tabela de bloqueios ainda não existe no Supabase. Execute o script 'manual_date_blocks_schema.sql' no SQL Editor e recarregue a página.",
        );
      }

      function syncManualBlockDateConstraints() {
        const startInput = document.getElementById("manual-block-start-date");
        const endInput = document.getElementById("manual-block-end-date");
        if (!startInput || !endInput) return;
        const todayIso = getTodayIsoDate();
        startInput.min = todayIso;
        endInput.min =
          startInput.value && startInput.value > todayIso
            ? startInput.value
            : todayIso;
      }

      function initManualBlockFormConstraints() {
        if (manualBlockFormInitialized) return;
        const startInput = document.getElementById("manual-block-start-date");
        const endInput = document.getElementById("manual-block-end-date");
        if (!startInput || !endInput) return;

        startInput.addEventListener("change", syncManualBlockDateConstraints);
        endInput.addEventListener("focus", syncManualBlockDateConstraints);
        manualBlockFormInitialized = true;
        syncManualBlockDateConstraints();
      }

      async function validateManualBlockRules(startDate, endDate) {
        const todayIso = getTodayIsoDate();

        if (startDate < todayIso || endDate < todayIso) {
          return {
            valid: false,
            message: "Não é permitido bloquear datas anteriores à data atual.",
          };
        }

        if (startDate > endDate) {
          return {
            valid: false,
            message: "A data início não pode ser maior que a data fim.",
          };
        }

        const { count, error } = await supabaseApp
          .from("reservations")
          .select("id", { count: "exact", head: true })
          .lte("check_in", endDate)
          .gt("check_out", startDate)
          .neq("status", "cancelled");

        if (error) throw error;

        if ((count || 0) > 0) {
          return {
            valid: false,
            message:
              "Não é possível bloquear este período porque já existem datas ocupadas por reserva.",
          };
        }

        return { valid: true };
      }

      function openManualBlockForm() {
        const panel = document.getElementById("manual-block-form-panel");
        if (!panel) return;
        panel.classList.remove("hidden");
        syncManualBlockDateConstraints();
        if (!currentManualBlockEditId) {
          resetManualBlockForm();
        }
      }

      function closeManualBlockForm() {
        const panel = document.getElementById("manual-block-form-panel");
        if (!panel) return;
        panel.classList.add("hidden");
        resetManualBlockForm();
      }

      function resetManualBlockForm() {
        currentManualBlockEditId = null;
        const idInput = document.getElementById("manual-block-id");
        const nameInput = document.getElementById("manual-block-client-name");
        const startInput = document.getElementById("manual-block-start-date");
        const endInput = document.getElementById("manual-block-end-date");
        const notesInput = document.getElementById("manual-block-notes");
        const title = document.getElementById("manual-block-form-title");
        const submitLabel = document.getElementById("manual-block-submit-label");

        if (idInput) idInput.value = "";
        if (nameInput) nameInput.value = "";
        if (startInput) startInput.value = "";
        if (endInput) endInput.value = "";
        if (notesInput) notesInput.value = "";
        if (title) title.innerText = "Bloquear período no calendário";
        if (submitLabel) submitLabel.innerText = "Salvar bloqueio";
        syncManualBlockDateConstraints();
      }

      function editManualBlock(id) {
        const block = manualDateBlocks.find((item) => item.id === id);
        if (!block) {
          alert("Bloqueio não encontrado.");
          return;
        }
        currentManualBlockEditId = id;

        const panel = document.getElementById("manual-block-form-panel");
        const idInput = document.getElementById("manual-block-id");
        const nameInput = document.getElementById("manual-block-client-name");
        const startInput = document.getElementById("manual-block-start-date");
        const endInput = document.getElementById("manual-block-end-date");
        const notesInput = document.getElementById("manual-block-notes");
        const title = document.getElementById("manual-block-form-title");
        const submitLabel = document.getElementById("manual-block-submit-label");

        if (panel) panel.classList.remove("hidden");
        if (idInput) idInput.value = block.id;
        if (nameInput) nameInput.value = block.client_name || "";
        if (startInput) startInput.value = block.start_date || "";
        if (endInput) endInput.value = block.end_date || "";
        if (notesInput) notesInput.value = block.notes || "";
        if (title) title.innerText = "Editar bloqueio manual";
        if (submitLabel) submitLabel.innerText = "Atualizar bloqueio";
        syncManualBlockDateConstraints();
      }

      async function saveManualBlock(event) {
        event.preventDefault();
        const idInput = document.getElementById("manual-block-id");
        const nameInput = document.getElementById("manual-block-client-name");
        const startInput = document.getElementById("manual-block-start-date");
        const endInput = document.getElementById("manual-block-end-date");
        const notesInput = document.getElementById("manual-block-notes");
        const submitButton = document.getElementById("manual-block-submit");

        const blockId = idInput?.value || currentManualBlockEditId;
        const clientName = (nameInput?.value || "").trim();
        const startDate = (startInput?.value || "").trim();
        const endDate = (endInput?.value || "").trim();
        const notes = (notesInput?.value || "").trim();

        if (!clientName || !startDate || !endDate) {
          alert("Preencha nome/referência, data início e data fim.");
          return;
        }

        if (startDate > endDate) {
          alert("A data início não pode ser maior que a data fim.");
          return;
        }

        if (submitButton) submitButton.disabled = true;

        try {
          const validation = await validateManualBlockRules(startDate, endDate);
          if (!validation.valid) {
            alert(validation.message);
            return;
          }

          const payload = {
            client_name: clientName,
            start_date: startDate,
            end_date: endDate,
            notes: notes || null,
            updated_at: new Date().toISOString(),
          };

          let result;
          if (blockId) {
            result = await supabaseApp
              .from("manual_date_blocks")
              .update(payload)
              .eq("id", blockId);
          } else {
            result = await supabaseApp.from("manual_date_blocks").insert({
              ...payload,
              is_active: true,
            });
          }

          if (result.error) throw result.error;

          closeManualBlockForm();
          await fetchAllData();
        } catch (error) {
          console.error("Erro ao salvar bloqueio manual:", error);
          if (isManualBlocksTableMissing(error)) {
            showManualBlocksTableMissingAlert();
            return;
          }
          alert("Erro ao salvar bloqueio manual. Verifique o banco e tente.");
        } finally {
          if (submitButton) submitButton.disabled = false;
        }
      }

      async function toggleManualBlockStatus(id, makeActive) {
        const actionLabel = makeActive ? "marcar como indisponível" : "disponibilizar";
        if (!confirm(`Deseja ${actionLabel} este período?`)) return;
        try {
          if (makeActive) {
            const block = manualDateBlocks.find((item) => item.id === id);
            if (!block) {
              alert("Bloqueio não encontrado.");
              return;
            }
            const validation = await validateManualBlockRules(
              block.start_date,
              block.end_date,
            );
            if (!validation.valid) {
              alert(validation.message);
              return;
            }
          }

          const { error } = await supabaseApp
            .from("manual_date_blocks")
            .update({
              is_active: makeActive,
              updated_at: new Date().toISOString(),
            })
            .eq("id", id);
          if (error) throw error;
          await fetchAllData();
        } catch (e) {
          console.error("Erro ao atualizar status do bloqueio:", e);
          if (isManualBlocksTableMissing(e)) {
            showManualBlocksTableMissingAlert();
            return;
          }
          alert("Não foi possível atualizar o status do bloqueio.");
        }
      }

      async function deleteManualBlock(id) {
        if (!confirm("Deseja excluir este bloqueio manual?")) return;
        try {
          const { error } = await supabaseApp
            .from("manual_date_blocks")
            .delete()
            .eq("id", id);
          if (error) throw error;

          if (currentManualBlockEditId === id) {
            closeManualBlockForm();
          }
          await fetchAllData();
        } catch (e) {
          console.error("Erro ao excluir bloqueio manual:", e);
          if (isManualBlocksTableMissing(e)) {
            showManualBlocksTableMissingAlert();
            return;
          }
          alert("Não foi possível excluir o bloqueio.");
        }
      }

      function renderManualBlockList() {
        const tbody = document.getElementById("manual-block-body");
        const cards = document.getElementById("manual-block-cards");
        const empty = document.getElementById("manual-block-empty");
        const tableWrapper = document.getElementById("manual-block-table-wrapper");
        const countLabel = document.getElementById("manual-block-count");

        if (!tbody || !cards || !empty || !tableWrapper || !countLabel) return;

        const sortedBlocks = [...manualDateBlocks].sort(
          (a, b) => new Date(a.start_date) - new Date(b.start_date),
        );
        const activeCount = sortedBlocks.filter((b) => b.is_active).length;
        countLabel.textContent = `${activeCount} ativo${activeCount === 1 ? "" : "s"} de ${sortedBlocks.length}`;

        tbody.innerHTML = "";
        cards.innerHTML = "";

        if (sortedBlocks.length === 0) {
          empty.classList.remove("hidden");
          tableWrapper.classList.add("hidden");
          return;
        }

        empty.classList.add("hidden");
        tableWrapper.classList.remove("hidden");

        sortedBlocks.forEach((block) => {
          const statusLabel = block.is_active ? "Indisponível" : "Disponível";
          const statusClass = block.is_active
            ? "bg-gray-200 text-gray-900 border border-gray-500"
            : "bg-emerald-50 text-emerald-700 border border-emerald-300";
          const refName = escapeHtml(block.client_name || "Sem referência");
          const notes = escapeHtml(block.notes || "-");
          const period = `${formatShortDateBR(block.start_date)} → ${formatShortDateBR(block.end_date)}`;
          const toggleLabel = block.is_active ? "Disponibilizar" : "Indisponível";
          const toggleClass = block.is_active
            ? "bg-emerald-50 text-emerald-700 hover:bg-emerald-100"
            : "bg-slate-100 text-slate-700 hover:bg-slate-200";

          tbody.innerHTML += `
            <tr class="hover:bg-gray-50 transition">
              <td class="px-4 py-3 font-semibold text-gray-800">${refName}</td>
              <td class="px-4 py-3 text-gray-600">${period}</td>
              <td class="px-4 py-3">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusLabel}</span>
              </td>
              <td class="px-4 py-3 text-gray-600">${notes}</td>
              <td class="px-4 py-3">
                <div class="flex justify-end gap-2">
                  <button onclick="editManualBlock('${block.id}')" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-blue-50 text-blue-700 hover:bg-blue-100">Editar</button>
                  <button onclick="toggleManualBlockStatus('${block.id}', ${block.is_active ? "false" : "true"})" class="px-2.5 py-1.5 text-xs font-semibold rounded-md ${toggleClass}">${toggleLabel}</button>
                  <button onclick="deleteManualBlock('${block.id}')" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-red-50 text-red-700 hover:bg-red-100">Excluir</button>
                </div>
              </td>
            </tr>
          `;

          cards.innerHTML += `
            <div class="border border-gray-100 rounded-xl p-4 bg-white shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold text-gray-800">${refName}</p>
                  <p class="text-xs text-gray-500 mt-1">${period}</p>
                </div>
                <span class="px-2 py-1 text-[0.7rem] font-semibold rounded-full ${statusClass} whitespace-nowrap">${statusLabel}</span>
              </div>
              <p class="mt-3 text-xs text-gray-600">${notes}</p>
              <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="editManualBlock('${block.id}')" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-blue-50 text-blue-700 hover:bg-blue-100">Editar</button>
                <button onclick="toggleManualBlockStatus('${block.id}', ${block.is_active ? "false" : "true"})" class="px-2.5 py-1.5 text-xs font-semibold rounded-md ${toggleClass}">${toggleLabel}</button>
                <button onclick="deleteManualBlock('${block.id}')" class="px-2.5 py-1.5 text-xs font-semibold rounded-md bg-red-50 text-red-700 hover:bg-red-100">Excluir</button>
              </div>
            </div>
          `;
        });
      }

      // --- CALENDAR LOGIC ---
      function getCalendarYears() {
        const years = new Set();
        allReservations.forEach((r) => {
          if (r.check_in)
            years.add(new Date(r.check_in + "T12:00:00").getFullYear());
          if (r.check_out)
            years.add(new Date(r.check_out + "T12:00:00").getFullYear());
        });
        manualDateBlocks.forEach((block) => {
          if (block.start_date)
            years.add(new Date(block.start_date + "T12:00:00").getFullYear());
          if (block.end_date)
            years.add(new Date(block.end_date + "T12:00:00").getFullYear());
        });
        years.add(new Date().getFullYear());
        return Array.from(years).sort((a, b) => a - b);
      }

      function initCalendarFilters() {
        const monthSelect = document.getElementById("calendar-month-select");
        const yearSelect = document.getElementById("calendar-year-select");
        if (!monthSelect || !yearSelect) return;

        monthSelect.innerHTML = calendarMonthNames
          .map((name, index) => `<option value="${index}">${name}</option>`)
          .join("");

        const yearOptions = getCalendarYears();
        const currentYear = currentDate.getFullYear();
        if (!yearOptions.includes(currentYear)) yearOptions.push(currentYear);
        yearOptions.sort((a, b) => a - b);
        yearSelect.innerHTML = yearOptions
          .map((year) => `<option value="${year}">${year}</option>`)
          .join("");

        monthSelect.value = String(currentDate.getMonth());
        yearSelect.value = String(currentYear);

        if (!calendarFiltersInitialized) {
          monthSelect.addEventListener("change", () => {
            currentDate.setMonth(parseInt(monthSelect.value, 10));
            renderCalendar();
          });
          yearSelect.addEventListener("change", () => {
            currentDate.setFullYear(parseInt(yearSelect.value, 10));
            renderCalendar();
          });
          calendarFiltersInitialized = true;
        }

        syncCalendarViewControls();
      }

      function syncCalendarViewControls() {
        const monthBtn = document.getElementById("calendar-view-month");
        const yearBtn = document.getElementById("calendar-view-year");
        const monthFilter = document.getElementById("calendar-month-filter");
        const monthSelect = document.getElementById("calendar-month-select");
        const monthView = document.getElementById("calendar-month-view");
        const yearView = document.getElementById("calendar-year-view");

        if (monthBtn && yearBtn) {
          if (calendarViewMode === "month") {
            monthBtn.classList.add("bg-gray-100", "text-gray-800");
            monthBtn.classList.remove("text-gray-500");
            yearBtn.classList.remove("bg-gray-100", "text-gray-800");
            yearBtn.classList.add("text-gray-500");
          } else {
            yearBtn.classList.add("bg-gray-100", "text-gray-800");
            yearBtn.classList.remove("text-gray-500");
            monthBtn.classList.remove("bg-gray-100", "text-gray-800");
            monthBtn.classList.add("text-gray-500");
          }
        }

        if (monthFilter && monthSelect) {
          if (calendarViewMode === "year") {
            monthFilter.classList.add("opacity-60");
            monthSelect.disabled = true;
          } else {
            monthFilter.classList.remove("opacity-60");
            monthSelect.disabled = false;
          }
        }

        if (monthView && yearView) {
          monthView.classList.toggle("hidden", calendarViewMode === "year");
          yearView.classList.toggle("hidden", calendarViewMode === "month");
        }
      }

      function setCalendarView(mode) {
        if (mode !== "month" && mode !== "year") return;
        calendarViewMode = mode;
        syncCalendarViewControls();
        renderCalendar();
      }

      function changeMonth(delta) {
        if (calendarViewMode === "year") {
          currentDate.setFullYear(currentDate.getFullYear() + delta);
        } else {
          currentDate.setMonth(currentDate.getMonth() + delta);
        }
        renderCalendar();
      }

      function renderCalendar() {
        initCalendarFilters();
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        renderManualBlockList();
        closeCalendarDayDetails();

        // Update title
        if (calendarViewMode === "year") {
          document.getElementById("calendar-month-title").innerText =
            `Calendário ${year}`;
          renderYearCalendar(year);
          return;
        }

        document.getElementById("calendar-month-title").innerText =
          `${calendarMonthNames[month].toLowerCase()} de ${year}`;
        renderMonthCalendar(year, month);
        renderCalendarList(year, month);
      }

      function isReservationCancelled(reservation) {
        const status = String(reservation?.status || "").toLowerCase();
        return status === "cancelled" || status === "canceled";
      }

      function getDayContext(dateStr) {
        const activeBlocks = manualDateBlocks.filter(
          (block) =>
            block.is_active &&
            dateStr >= block.start_date &&
            dateStr <= block.end_date,
        );
        const reservations = allReservations.filter((reservation) => {
          if (!reservation.check_in || !reservation.check_out) return false;
          if (isReservationCancelled(reservation)) return false;
          return dateStr >= reservation.check_in && dateStr < reservation.check_out;
        });

        const approvedReservations = reservations.filter(
          (reservation) =>
            !!reservation.admin_signature_url ||
            reservation.status === "approved" ||
            reservation.status === "confirmed" ||
            reservation.status === "completed",
        );
        const pendingReservations = reservations.filter(
          (reservation) => !approvedReservations.includes(reservation),
        );

        return {
          activeBlocks,
          reservations,
          approvedReservations,
          pendingReservations,
        };
      }

      function getDayStatusClass(dayContext) {
        if (dayContext.activeBlocks.length) return "is-unavailable";
        if (dayContext.pendingReservations.length) return "is-attention";
        if (dayContext.approvedReservations.length) return "is-soldout";
        return "is-available";
      }

      function getDayTooltipFromContext(dayContext) {
        const tooltipParts = [];
        if (dayContext.activeBlocks.length) {
          tooltipParts.push(
            `Indisponível: ${dayContext.activeBlocks.map((block) => block.client_name || "Manual").join(", ")}`,
          );
        }
        if (dayContext.approvedReservations.length) {
          tooltipParts.push(
            `Confirmado: ${dayContext.approvedReservations.map((reservation) => reservation.clients?.full_name || "Hóspede").join(", ")}`,
          );
        }
        if (dayContext.pendingReservations.length) {
          tooltipParts.push(
            `Atenção: ${dayContext.pendingReservations.map((reservation) => reservation.clients?.full_name || "Hóspede").join(", ")}`,
          );
        }
        return tooltipParts.join(" | ");
      }

      function closeCalendarDayDetails() {
        const card = document.getElementById("calendar-day-detail-card");
        if (!card) return;
        card.classList.add("hidden");
      }

      function openCalendarDayDetails(dateStr) {
        const card = document.getElementById("calendar-day-detail-card");
        const title = document.getElementById("calendar-day-detail-title");
        const list = document.getElementById("calendar-day-detail-list");
        if (!card || !title || !list) return;

        const dayContext = getDayContext(dateStr);
        title.innerText = `Detalhes de ${formatShortDateBR(dateStr)}`;
        list.innerHTML = "";

        if (!dayContext.activeBlocks.length && !dayContext.reservations.length) {
          list.innerHTML =
            '<div class="calendar-day-detail-item">Dia disponível para reservas.</div>';
          card.classList.remove("hidden");
          return;
        }

        dayContext.activeBlocks.forEach((block) => {
          const name = escapeHtml(block.client_name || "Indisponível manual");
          const notes = escapeHtml(block.notes || "Sem observações");
          const period = `${formatShortDateBR(block.start_date)} → ${formatShortDateBR(block.end_date)}`;
          list.innerHTML += `
            <div class="calendar-day-detail-item is-unavailable">
              <p class="font-semibold text-slate-900">Indisponível • ${name}</p>
              <p class="text-xs text-slate-600 mt-1">${period}</p>
              <p class="text-xs text-slate-600 mt-1">${notes}</p>
            </div>
          `;
        });

        dayContext.approvedReservations.forEach((reservation) => {
          const client = escapeHtml(reservation.clients?.full_name || "Hóspede");
          const period = `${formatShortDateBR(reservation.check_in)} → ${formatShortDateBR(reservation.check_out)}`;
          list.innerHTML += `
            <div class="calendar-day-detail-item is-soldout">
              <p class="font-semibold text-slate-900">Esgotado • ${client}</p>
              <p class="text-xs text-slate-600 mt-1">${period}</p>
            </div>
          `;
        });

        dayContext.pendingReservations.forEach((reservation) => {
          const client = escapeHtml(reservation.clients?.full_name || "Hóspede");
          const period = `${formatShortDateBR(reservation.check_in)} → ${formatShortDateBR(reservation.check_out)}`;
          list.innerHTML += `
            <div class="calendar-day-detail-item is-attention">
              <p class="font-semibold text-slate-900">Precisa de atenção • ${client}</p>
              <p class="text-xs text-slate-600 mt-1">${period}</p>
            </div>
          `;
        });

        card.classList.remove("hidden");
      }

      function renderMonthCalendar(year, month) {
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const grid = document.getElementById("calendar-grid");
        if (!grid) return;
        grid.innerHTML = "";

        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(
          today.getMonth() + 1,
        ).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

        // Blank days
        for (let i = 0; i < firstDay; i++) {
          grid.innerHTML += `<div class="calendar-day is-empty"></div>`;
        }

        // Days
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          const isToday = dateStr === todayStr;

          const dayContext = getDayContext(dateStr);
          const dayStatusClass = getDayStatusClass(dayContext);
          const dayTitle = escapeHtml(getDayTooltipFromContext(dayContext));
          const eventsCount =
            dayContext.activeBlocks.length + dayContext.reservations.length;
          const metaHtml =
            eventsCount > 0
              ? `<span class="calendar-day-meta">${eventsCount}</span>`
              : "";

          grid.innerHTML += `
                    <div class="calendar-day ${isToday ? "is-today" : ""} ${dayStatusClass}" title="${dayTitle}" onclick="openCalendarDayDetails('${dateStr}')">
                        <span class="calendar-day-number">${day}</span>
                        ${metaHtml}
                    </div>
                `;
        }
      }

      function getReservationStatusForDate(dateStr) {
        const dayContext = getDayContext(dateStr);
        if (dayContext.activeBlocks.length) return "unavailable";
        if (dayContext.pendingReservations.length) return "pending";
        if (dayContext.approvedReservations.length) return "approved";
        return null;
      }

      function renderYearCalendar(year) {
        const grid = document.getElementById("calendar-year-grid");
        if (!grid) return;
        grid.innerHTML = "";

        const weekdayLabels = ["D", "S", "T", "Q", "Q", "S", "S"];

        for (let month = 0; month < 12; month++) {
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          let daysHtml = "";

          for (let i = 0; i < firstDay; i++) {
            daysHtml += `<div class="calendar-year-day is-empty" aria-hidden="true"></div>`;
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
            const status = getReservationStatusForDate(dateStr);
            const statusClass =
              status === "unavailable"
                ? "is-unavailable"
                : status === "approved"
                ? "is-approved"
                : status === "pending"
                  ? "is-pending"
                  : "";
            const dayTitle = escapeHtml(
              getDayTooltipFromContext(getDayContext(dateStr)),
            );

            daysHtml += `
                        <div class="calendar-year-day ${statusClass ? `has-status ${statusClass}` : ""}" title="${dayTitle}" onclick="openCalendarDayDetails('${dateStr}')">
                            <span>${day}</span>
                        </div>
                    `;
          }

          grid.innerHTML += `
                    <div class="calendar-year-card">
                        <div class="calendar-year-header">
                            <span class="text-sm font-semibold text-slate-700">${calendarMonthNames[month]}</span>
                            <span class="text-xs text-slate-400">${year}</span>
                        </div>
                        <div class="calendar-year-weekdays">
                            ${weekdayLabels.map((label) => `<div class="text-center">${label}</div>`).join("")}
                        </div>
                        <div class="calendar-year-days">
                            ${daysHtml}
                        </div>
                    </div>
                `;
        }
      }

      function renderCalendarList(year, month) {
        const tbody = document.getElementById("calendar-reservations-body");
        const empty = document.getElementById("calendar-empty");
        const tableWrapper = document.getElementById("calendar-list-table");
        const countLabel = document.getElementById("calendar-list-count");
        const cards = document.getElementById("calendar-reservations-cards");

        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);

        const monthReservations = allReservations
          .filter((r) => {
            if (!r.check_in || !r.check_out) return false;
            const start = new Date(r.check_in + "T12:00:00");
            const end = new Date(r.check_out + "T12:00:00");
            return start <= monthEnd && end >= monthStart;
          })
          .sort((a, b) => new Date(a.check_in) - new Date(b.check_in));

        if (countLabel) {
          countLabel.textContent = `${monthReservations.length} ${monthReservations.length === 1 ? "reserva" : "reservas"}`;
        }

        if (!tbody) return;
        tbody.innerHTML = "";
        if (cards) {
          cards.innerHTML = "";
        }

        if (monthReservations.length === 0) {
          empty?.classList.remove("hidden");
          tableWrapper?.classList.add("hidden");
          return;
        }

        empty?.classList.add("hidden");
        tableWrapper?.classList.remove("hidden");

        monthReservations.forEach((res) => {
          let statusLabel = "Pendente";
          let statusClass = "bg-yellow-100 text-yellow-700";

          if (res.admin_signature_url) {
            statusLabel = "Confirmado";
            statusClass = "bg-green-100 text-green-700";
          } else if (res.contract_signed_url) {
            statusLabel = "Assinado (Cliente)";
            statusClass = "bg-blue-100 text-blue-700";
          }

          const value = new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL",
          }).format(parseFloat(res.total_amount || res.total_value || 0));

          const startDate = new Date(
            res.check_in + "T12:00:00",
          ).toLocaleDateString("pt-BR");
          const endDate = new Date(
            res.check_out + "T12:00:00",
          ).toLocaleDateString("pt-BR");

          tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 font-semibold text-gray-800">${res.clients?.full_name || "Hóspede"}</td>
                        <td class="px-4 py-3 text-gray-600">${startDate} → ${endDate}</td>
                        <td class="px-4 py-3 font-semibold text-gray-700">${value}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusLabel}</span>
                        </td>
                    </tr>
                `;

          if (cards) {
            cards.innerHTML += `
                        <div class="border border-gray-100 rounded-xl p-4 bg-white shadow-sm">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">${res.clients?.full_name || "Hóspede"}</p>
                                    <p class="text-xs text-gray-500 mt-1">${startDate} → ${endDate}</p>
                                </div>
                                <span class="px-2 py-1 text-[0.7rem] font-semibold rounded-full ${statusClass} whitespace-nowrap">${statusLabel}</span>
                            </div>
                            <div class="mt-3 text-sm font-semibold text-gray-700">${value}</div>
                        </div>
                    `;
          }
        });
      }

      // --- INITIALIZATION ---
      function initDashboard() {
        lucide.createIcons();
        initManualBlockFormConstraints();
        fetchAllData();
        initSignaturePad();
      }

      window.addEventListener("message", (event) => {
        if (!event || !event.data || typeof event.data !== "object") return;
        if (event.data.type === "admin-edit-saved") {
          closeEditModal();
          fetchAllData();
        }
        if (event.data.type === "admin-edit-close") {
          closeEditModal();
        }
      });

      // --- SIGNATURE PAD ---
      function initSignaturePad() {
        signatureCanvas = document.getElementById("signature-pad");
        signatureCtx = signatureCanvas.getContext("2d");
        signatureCtx.strokeStyle = "#111";
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = "round";

        resizeSignaturePad();
        window.addEventListener("resize", resizeSignaturePad);

        const start = (e) => {
          signatureDrawing = true;
          const { x, y } = getSignaturePos(e);
          signatureCtx.beginPath();
          signatureCtx.moveTo(x, y);
          e.preventDefault();
        };

        const move = (e) => {
          if (!signatureDrawing) return;
          const { x, y } = getSignaturePos(e);
          signatureCtx.lineTo(x, y);
          signatureCtx.stroke();
          e.preventDefault();
        };

        const end = () => {
          signatureDrawing = false;
        };

        signatureCanvas.addEventListener("mousedown", start);
        signatureCanvas.addEventListener("touchstart", start, {
          passive: false,
        });
        signatureCanvas.addEventListener("mousemove", move);
        signatureCanvas.addEventListener("touchmove", move, { passive: false });
        signatureCanvas.addEventListener("mouseup", end);
        signatureCanvas.addEventListener("touchend", end);
      }

      function resizeSignaturePad() {
        if (!signatureCanvas || !signatureCtx) return;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const width = signatureCanvas.offsetWidth;
        const height = signatureCanvas.offsetHeight;
        signatureCanvas.width = width * ratio;
        signatureCanvas.height = height * ratio;
        signatureCtx.setTransform(1, 0, 0, 1, 0, 0);
        signatureCtx.scale(ratio, ratio);
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = "round";
        signatureCtx.strokeStyle = "#111";
      }

      function getSignaturePos(e) {
        const rect = signatureCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      function clearSignature() {
        if (!signatureCanvas || !signatureCtx) return;
        signatureCtx.clearRect(
          0,
          0,
          signatureCanvas.width,
          signatureCanvas.height,
        );
      }

      function openSignModal(id) {
        currentReservationId = id;
        const signatureModal = document.getElementById("signature-modal");
        signatureModal.classList.remove("hidden");
        signatureModal.classList.add("flex");
        setTimeout(() => {
          resizeSignaturePad();
          clearSignature();
        }, 80);
      }

      function closeModal() {
        const signatureModal = document.getElementById("signature-modal");
        signatureModal.classList.add("hidden");
        signatureModal.classList.remove("flex");
      }

      async function confirmSignature() {
        if (!currentReservationId) return;
        const canvas = document.getElementById("signature-pad");
        const btn = document.getElementById("btn-confirm-sign");
        const reservation = allReservations.find(
          (r) => r.id === currentReservationId,
        );

        btn.innerText = "Processando...";
        btn.disabled = true;

        try {
          if (!reservation) {
            throw new Error("Reserva não encontrada.");
          }

          const signatureDataUrl = canvas.toDataURL("image/png");
          const blob = await (await fetch(signatureDataUrl)).blob();
          const filename = `admin_sig_${currentReservationId}_${Date.now()}.png`;

          const { error } = await supabaseApp.storage
            .from("contracts")
            .upload(filename, blob);
          if (error) throw error;

          const publicUrl = supabaseApp.storage
            .from("contracts")
            .getPublicUrl(filename).data.publicUrl;

          const finalContractUrl = await generateFinalContractPdf(
            reservation,
            signatureDataUrl,
          );

          await supabaseApp
            .from("reservations")
            .update({
              admin_signature_url: publicUrl,
              final_contract_url: finalContractUrl,
              status: "approved",
              admin_signed_at: new Date().toISOString(),
            })
            .eq("id", currentReservationId);

          const clientPhone = normalizePhone(reservation.clients?.phone);
          const whatsappResult = await sendWhatsAppViaN8n({
            pdfUrl: finalContractUrl,
            contractId: reservation.id,
            clientName: reservation.clients?.full_name || "",
            clientPhone,
            companyPhone: "",
            filename: `Contrato-${reservation.id}.pdf`,
            sendToClient: true,
            source: "admin-sign",
            checkinDate: reservation.check_in,
            checkoutDate: reservation.check_out,
          });

          if (!whatsappResult.success) {
            alert(
              `Assinado, mas não foi possível enviar via WhatsApp: ${whatsappResult.error}`,
            );
          } else {
            alert("Assinado e enviado via WhatsApp para cliente e Plenitur!");
          }

          closeModal();
          fetchAllData(); // Refresh
        } catch (e) {
          alert("Erro: " + e.message);
          console.error(e);
        } finally {
          btn.innerText = "Confirmar Assinatura";
          btn.disabled = false;
        }
      }

      // Auto-run
      checkLogin();
    </script>
  </body>
</html>
